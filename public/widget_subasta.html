<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget Subasta</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: transparent;
      height: 100vh;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      margin: 0;
      overflow: hidden;
      min-height: 100vh;
    }
    
    .widget-container {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      border: 4px solid #ffd700;
      border-radius: 25px;
      padding: 25px;
      width: 98%;
      max-width: 450px;
      height: 98vh;
      color: white;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
      display: flex;
      flex-direction: column;
    }
    
    /* Header con Timer */
    .header {
      text-align: center;
      margin-bottom: 15px;
    }
    
    .title {
      display:none;
      font-size: 28px;
      color: #ffd700;
      margin-bottom: 15px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
      font-weight: 900;
    }
    
    .timer-container {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 18px;
      padding: 25px;
      margin: 18px 0;
      border: 3px solid #4ecdc4; /* Color verde por defecto */
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.3s ease; /* Transici√≥n suave para el borde */
    }
    
    .timer {
      font-size: 52px;
      font-weight: 900; /* M√°s grueso que bold */
      color: #4ecdc4; /* Color verde por defecto */
      text-shadow: 0 0 22px rgba(78, 205, 196, 0.8); /* Sombra verde por defecto */
      font-family: 'Courier New', monospace;
      letter-spacing: 4px;
      position: relative;
      transform: scaleX(1.2) scaleY(1.2);
      z-index: 2;
      transition: color 0.3s ease, text-shadow 0.3s ease; /* Transiciones suaves */
      /* Remover webkit-text-stroke fijo para permitir colores din√°micos */
    }
    
    /* Estilo espec√≠fico para cuando el timer est√° finalizado */
    .timer.finalizado {
      font-size: 16px;
      transform: scaleX(1) scaleY(1) !important;
      letter-spacing: 2px !important;
    }
    
    /* Indicadores de tiempo invisible */
    .tiempo-indicador {
      position: absolute;
      font-size: 28px;
      font-weight: 900;
      font-family: 'Courier New', monospace;
      z-index: 1;
      opacity: 0;
      pointer-events: none;
      text-shadow: 0 0 12px currentColor;
    }
    
    .tiempo-positivo {
      right: 20px;
      color: #4caf50;
      font-weight: 900;
      animation: tiempo-positivo-animacion 2.5s ease-out forwards;
    }
    
    /* Estilos para el sistema de tiempo snipe */
    .mensaje-snipe {
      animation: aparecerSnipe 0.5s ease-out;
    }
    
    @keyframes aparecerSnipe {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }
    
    @keyframes parpadeoSnipe {
      0%, 100% { 
        opacity: 1; 
        text-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
      }
      50% { 
        opacity: 0.7; 
        text-shadow: 0 0 30px rgba(255, 107, 107, 1);
      }
    }
    
    .ranking.finalizado {
      border: 3px solid #ffd700 !important;
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.6) !important;
    }
    
    .donador.finalizado {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.05) 100%) !important;
      border-color: rgba(255, 215, 0, 0.3) !important;
    }
    
    .tiempo-negativo {
      left: 20px;
      color: #f44336;
      font-weight: 900;
      animation: tiempo-negativo-animacion 2.5s ease-out forwards;
    }
    
    @keyframes tiempo-positivo-animacion {
      0% {
        opacity: 0;
        transform: translateX(20px) scale(0.8);
      }
      20% {
        opacity: 1;
        transform: translateX(0) scale(1.1);
      }
      80% {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateX(-20px) scale(0.8);
      }
    }
    
    @keyframes tiempo-negativo-animacion {
      0% {
        opacity: 0;
        transform: translateX(-20px) scale(0.8);
      }
      20% {
        opacity: 1;
        transform: translateX(0) scale(1.1);
      }
      80% {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateX(20px) scale(0.8);
      }
    }
    
    .status {
      display:none;
      font-size: 20px;
      color: #4ecdc4;
      margin-top: 10px;
      font-weight: 900;
    }
    
    /* Top 10 Ranking */
    .ranking-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      /* padding: 15px; */
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .ranking-title {
      display: none;
      text-align: center;
      font-size: 20px;
      color: #ffd700;
      margin-bottom: 20px;
      font-weight: 900;
    }
    
         .ranking {
       display: flex;
       flex-direction: column;
       gap: 16px;
       flex: 1;
       overflow-y: hidden;
       overflow-x: hidden;
       padding: 16px;
       min-height: 0;
     }
    
         .ranking.finalizado {
       grid-template-columns: 1fr;
       max-height: none;
       gap: 20px;
       width: 100%;
       overflow: visible;
       padding: 0;
       flex: 1;
       justify-content: center;
     }
    
         .donador {
       background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
       border: 2px solid rgba(255, 255, 255, 0.2);
       border-radius: 16px;
       padding: 20px;
       display: flex;
       align-items: center;
       gap: 18px;
       transition: all 0.5s ease;
       position: relative;
       overflow: visible;
       box-sizing: border-box;
     }
    
    .donador:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 215, 0, 0.5);
    }
    
    .donador.cambio {
      animation: cambio-posicion 1.2s ease;
    }
    
    .donador.cambio-subida {
      animation: subida-posicion 1.5s ease;
    }
    
    .donador.cambio-bajada {
      animation: bajada-posicion 1.5s ease;
    }
    
    @keyframes cambio-posicion {
      0% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.05) rotate(-1deg); background: rgba(255, 215, 0, 0.3); }
      50% { transform: scale(1.08) rotate(1deg); background: rgba(255, 215, 0, 0.4); box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
      75% { transform: scale(1.05) rotate(-0.5deg); background: rgba(255, 215, 0, 0.3); }
      100% { transform: scale(1) rotate(0deg); }
    }
    
    @keyframes subida-posicion {
      0% { transform: translateY(0) scale(1); }
      25% { transform: translateY(-8px) scale(1.03); background: rgba(76, 175, 80, 0.3); border-color: #4caf50; }
      50% { transform: translateY(-12px) scale(1.06); background: rgba(76, 175, 80, 0.4); box-shadow: 0 0 20px rgba(76, 175, 80, 0.6); }
      75% { transform: translateY(-6px) scale(1.03); background: rgba(76, 175, 80, 0.3); }
      100% { transform: translateY(0) scale(1); }
    }
    
    @keyframes bajada-posicion {
      0% { transform: translateY(0) scale(1); }
      25% { transform: translateY(8px) scale(1.03); background: rgba(244, 67, 54, 0.3); border-color: #f44336; }
      50% { transform: translateY(12px) scale(1.06); background: rgba(244, 67, 54, 0.4); box-shadow: 0 0 20px rgba(244, 67, 54, 0.6); }
      75% { transform: translateY(6px) scale(1.03); background: rgba(244, 67, 54, 0.3); }
      100% { transform: translateY(0) scale(1); }
    }
    
         .position {
       width: 48px;
       height: 48px;
       border-radius: 50%;
       display: flex;
       align-items: center;
       justify-content: center;
       font-weight: 900;
       font-size: 20px;
       flex-shrink: 0;
       transition: all 0.5s ease;
     }
    
    .position-1 {
      background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
      color: #000;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }
    
    .position-2 {
      background: linear-gradient(135deg, #c0c0c0 0%, #e5e5e5 100%);
      color: #000;
      box-shadow: 0 0 10px rgba(192, 192, 192, 0.6);
    }
    
    .position-3 {
      background: linear-gradient(135deg, #cd7f32 0%, #daa520 100%);
      color: #fff;
      box-shadow: 0 0 10px rgba(205, 127, 50, 0.6);
    }
    
    .position-4-10 {
      background: linear-gradient(135deg, #4a4a4a 0%, #666 100%);
      color: #fff;
    }
    
         .foto {
       width: 62px;
       height: 62px;
       border-radius: 50%;
       background-size: cover;
       background-position: center;
       border: 4px solid #ffd700;
       flex-shrink: 0;
       box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
     }
    
    .info {
      flex: 1;
      min-width: 0;
    }
    
    .nombre {
      font-size: 22px;
      font-weight: 900;
      color: #fff;
      margin-bottom: 7px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
         .diamantes {
       font-size: 22px;
       font-weight: 900;
       color: #ffd700;
       display: flex;
       align-items: center;
       gap: 6px;
     }
     
     .diamantes .tiktok-coin {
       width: 24px;
       height: 24px;
       flex-shrink: 0;
     }
     
     .diamantes .tiktok-coin svg {
       width: 100%;
       height: 100%;
     }
    
    /* Estados especiales para finalizaci√≥n */
    .ganador {
      background: linear-gradient(135deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.2) 100%);
      border: 3px solid #ffd700;
      animation: ganador-glow 2s infinite;
      transform: scale(1.02);
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
         .ganador .foto {
       border: 4px solid #ffd700;
       box-shadow: 0 0 28px rgba(255, 215, 0, 0.8);
       width: 66px;
       height: 66px;
       flex-shrink: 0;
     }
    
         .ganador .position {
       width: 60px;
       height: 60px;
       font-size: 24px;
       box-shadow: 0 0 32px rgba(255, 215, 0, 0.8);
       flex-shrink: 0;
     }
    
         .ganador .nombre {
       font-size: 24px;
       color: #ffd700;
       text-shadow: 0 0 14px rgba(255, 215, 0, 0.5);
       white-space: nowrap;
       overflow: hidden;
       text-overflow: ellipsis;
       max-width: 240px;
     }
    
         .ganador .diamantes {
       font-size: 22px;
       color: #ffd700;
       text-shadow: 0 0 12px rgba(255, 215, 0, 0.5);
     }
    
         .finalizado .donador {
       padding: 28px 22px;
       margin-bottom: 18px;
       width: 100%;
       max-width: 100%;
       box-sizing: border-box;
       overflow: hidden;
     }
    
    .finalizado .donador:nth-child(2) {
      background: linear-gradient(135deg, rgba(192, 192, 192, 0.2) 0%, rgba(192, 192, 192, 0.1) 100%);
      border-color: rgba(192, 192, 192, 0.6);
    }
    
    .finalizado .donador:nth-child(3) {
      background: linear-gradient(135deg, rgba(205, 127, 50, 0.2) 0%, rgba(205, 127, 50, 0.1) 100%);
      border-color: rgba(205, 127, 50, 0.6);
    }
    
         .finalizado .donador .foto {
       width: 62px;
       height: 62px;
       flex-shrink: 0;
     }
    
         .finalizado .donador .position {
       width: 52px;
       height: 52px;
       font-size: 22px;
       flex-shrink: 0;
     }
    
         .finalizado .donador .nombre {
       font-size: 23px;
       max-width: 260px;
       white-space: nowrap;
       overflow: hidden;
       text-overflow: ellipsis;
     }
    
         .finalizado .donador .diamantes {
       font-size: 21px;
     }
    
         .ranking.finalizado .donador {
       margin: 0;
       gap: 22px;
     }
    
    @keyframes ganador-glow {
      0%, 100% { 
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
      }
      50% { 
        box-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 40px rgba(255, 215, 0, 0.8);
      }
    }
    
    /* Efectos de part√≠culas para cambios de posici√≥n */
    .particulas {
      position: absolute;
      pointer-events: none;
      z-index: 1000;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .particula {
      position: absolute;
      width: 3px;
      height: 3px;
      background: #ffd700;
      border-radius: 50%;
      animation: particula-vuelo 1s ease-out forwards;
      box-shadow: 0 0 4px currentColor;
    }
    
    @keyframes particula-vuelo {
      0% { 
        transform: translate(0, 0) scale(1); 
        opacity: 1; 
      }
      100% { 
        transform: translate(var(--x), var(--y)) scale(0); 
        opacity: 0; 
      }
    }
    
    /* Efecto de destello */
    .destello {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, transparent 30%, rgba(255, 215, 0, 0.6) 50%, transparent 70%);
      animation: destello-efecto 0.8s ease-out;
      pointer-events: none;
      z-index: 10;
      border-radius: 12px;
    }
    
    @keyframes destello-efecto {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    @keyframes flecha-subida {
      0% { transform: translateX(-50%) translateY(0) scale(0.5); opacity: 0; }
      50% { transform: translateX(-50%) translateY(-8px) scale(1.1); opacity: 1; }
      100% { transform: translateX(-50%) translateY(-15px) scale(1); opacity: 0; }
    }
    
    @keyframes flecha-bajada {
      0% { transform: translateX(-50%) translateY(0) scale(0.5); opacity: 0; }
      50% { transform: translateX(-50%) translateY(8px) scale(1.1); opacity: 1; }
      100% { transform: translateX(-50%) translateY(15px) scale(1); opacity: 0; }
    }
    
    /* Scrollbar personalizado */
    .ranking::-webkit-scrollbar {
      width: 8px;
    }
    
    .ranking::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }
    
    .ranking::-webkit-scrollbar-thumb {
      background: rgba(255, 215, 0, 0.5);
      border-radius: 4px;
    }
    
    .ranking::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 215, 0, 0.7);
    }
    
                  /* Responsive */
     @media (max-width: 600px) {
       .widget-container {
         max-width: 98%;
         padding: 20px;
         height: 95vh;
       }
       
       .timer {
         font-size: 44px;
       }
       
       .ranking {
         gap: 14px;
         padding: 14px;
       }
       
       .donador {
         padding: 18px;
         gap: 16px;
       }
       
             .position {
        width: 44px;
        height: 44px;
        font-size: 20px;
      }
       
       .foto {
         width: 56px;
         height: 56px;
       }
       
       .nombre {
         font-size: 20px;
       }
       
             .diamantes {
        font-size: 20px;
      }
    }
  </style>
  <script src="../js/socket.io.min.js"></script>
</head>
<body>
  <div class="widget-container">
    <!-- Header con Timer -->
    <div class="header">
      <div class="title">üéØ SUBASTA EN VIVO</div>
        <div id="labelminimo" class="nombre timer" style="display:none; color: #a4ffa7; font-size: 22px; font-weight: bold;"></div>
        <div class="timer-container">
          <div class="tiempo-indicador tiempo-negativo" id="tiempoNegativo"></div>
          <div style="display: flex; flex-direction: column;">
            <div class="timer" id="timer">00:00</div>
            <div id="delaytimercontainer" style="display: none; flex-direction: row; gap: 10px; align-items: center; justify-content: center;">
              <div style="color: #f8cb00; font-weight: 900; font-size: 20px;" id="delayTimerLabel">Tiempo por delay de live</div>
              <div style="font-size: 20px; font-weight: 900;" id="delaytimer">00:00</div>
            </div>
          </div>
          <div class="tiempo-indicador tiempo-positivo" id="tiempoPositivo"></div>
          <div class="status" id="status">Esperando donaciones para iniciar...</div>
        </div>
      </div>
    
    <!-- Top 10 Ranking -->
    <div class="ranking-container">
      <div class="ranking-title" id="rankingTitle"> TOP 10 DONADORES</div>
      <div class="ranking" id="ranking">
        <!-- Los donadores se generar√°n din√°micamente -->
      </div>
    </div>
  </div>

  <div>
    
  </div>
  <script>
    // Sistema de multiidioma para el widget
    const idiomasWidget = {
      espanol: {
        // Estados y mensajes principales
        esperandoDonaciones: "Esperando donaciones para iniciar...",
        subastaEnCurso: "Subasta en curso - ¬°Env√≠a regalos!",
        subastaPausada: "Subasta pausada",
        subastaFinalizada: "¬°SUBASTA FINALIZADA!",
        tiempoPorDelay: "Tiempo por delay de live",
        finalizado: "FINALIZADO",
        montminimo: "monto minimo",
        // Mensajes de snipe/delay
        tiempoSnipeActivo: "¬°TIEMPO POR DELAY ACTIVO!",
        noDonesMas: "‚ö†Ô∏è SI VES EL TIMER EN 0:00 NO DONES M√ÅS ‚ö†Ô∏è",
        tiempoSnipeFinalizado: "¬°TIEMPO POR DELAY FINALIZADO!",
        
        // Mensajes de ganador
        ganador: "¬°GANADOR!",
        empate: "¬°EMPATE!",
        ambosGanadores: "¬°Ambos son ganadores!",
        felicidades: "¬°Felicidades!",
        seVieneDesempate: "¬°Se viene desempate!",
        
        // T√≠tulos y etiquetas
        top10Donadores: "TOP 10 DONADORES",
        topFinalSubasta: "TOP FINAL - SUBASTA COMPLETADA",
        podioFinal: "üèÜ PODIO FINAL",
        participantes: "PARTICIPANTES",
        ticketsTotales: "Tickets Totales",
        totalParticipantes: "Total de participantes:",
        
        // Mensajes de estado
        esperandoIniciar: "No hay donadores a√∫n. La subasta comenzar√° cuando se inicie.",
        esperandoDonaciones: "Esperando donaciones...",
        sorteoIniciado: "¬°Sorteo iniciado! ¬°Preparando la ruleta!",
        sorteoEnCurso: "En Curso",
        sorteoFinalizado: "Finalizado",
        sorteoCompletado: "Completado",
        
        // Botones
        iniciar: "üöÄ Iniciar",
        sorteo: "üé≤ Sorteo",
        reiniciar: "üîÑ Reiniciar",
        girando: "üé≤ Girando...",
        
        // Mensajes de bloqueo
        subastaFinalizadaNoDonaciones: "üîí Subasta finalizada - No se aceptan m√°s donaciones",
        
        // Otros textos
        diamantes: ""
      },
      
      ingles: {
        esperandoDonaciones: "Waiting for donations to start...",
        subastaEnCurso: "Auction in progress - Send gifts!",
        subastaPausada: "Auction paused",
        subastaFinalizada: "AUCTION FINISHED!",
        tiempoPorDelay: "Time for live delay",
        finalizado: "FINISHED",
        montminimo: "minimum amount",
        tiempoSnipeActivo: "DELAY TIME ACTIVE!",
        noDonesMas: "‚ö†Ô∏è IF YOU SEE TIMER AT 0:00 DON'T DONATE MORE ‚ö†Ô∏è",
        tiempoSnipeFinalizado: "DELAY TIME FINISHED!",
        
        ganador: "WINNER!",
        empate: "TIE!",
        ambosGanadores: "Both are winners!",
        felicidades: "Congratulations!",
        seVieneDesempate: "Tiebreaker coming!",
        
        top10Donadores: "TOP 10 DONORS",
        topFinalSubasta: "FINAL TOP - AUCTION COMPLETED",
        podioFinal: "üèÜ FINAL PODIUM",
        participantes: "PARTICIPANTS",
        ticketsTotales: "Total Tickets",
        totalParticipantes: "Total participants:",
        
        esperandoIniciar: "No donors yet. The auction will start when initiated.",
        esperandoDonaciones: "Waiting for donations...",
        sorteoIniciado: "Raffle started! Preparing the wheel!",
        sorteoEnCurso: "In Progress",
        sorteoFinalizado: "Finished",
        sorteoCompletado: "Completed",
        
        iniciar: "üöÄ Start",
        sorteo: "üé≤ Raffle",
        reiniciar: "üîÑ Reset",
        girando: "üé≤ Spinning...",
        
        subastaFinalizadaNoDonaciones: "üîí Auction finished - No more donations accepted",
        
        // Otros textos
        diamantes: ""
      },
      
      portugues: {
        esperandoDonaciones: "Aguardando doa√ß√µes para iniciar...",
        subastaEnCurso: "Leil√£o em andamento - Envie presentes!",
        subastaPausada: "Leil√£o pausado",
        subastaFinalizada: "LEIL√ÉO FINALIZADO!",
        tiempoPorDelay: "Tempo para delay ao vivo",
        finalizado: "FINALIZADO",
        montminimo: "valor m√≠nimo",

        tiempoSnipeActivo: "TEMPO DE DELAY ATIVO!",
        noDonesMas: "‚ö†Ô∏è SE VOC√ä VER O TIMER EM 0:00 N√ÉO DOE MAIS ‚ö†Ô∏è",
        tiempoSnipeFinalizado: "TEMPO DE DELAY FINALIZADO!",
        
        ganador: "VENCEDOR!",
        empate: "EMPATE!",
        ambosGanadores: "Ambos s√£o vencedores!",
        felicidades: "Parab√©ns!",
        seVieneDesempate: "Desempate chegando!",
        
        top10Donadores: "TOP 10 DOADORES",
        topFinalSubasta: "TOP FINAL - LEIL√ÉO COMPLETADO",
        podioFinal: "üèÜ PODIUM FINAL",
        participantes: "PARTICIPANTES",
        ticketsTotales: "Total de Tickets",
        totalParticipantes: "Total de participantes:",
        
        esperandoIniciar: "Nenhum doador ainda. O leil√£o come√ßar√° quando iniciado.",
        esperandoDonaciones: "Aguardando doa√ß√µes...",
        sorteoIniciado: "Rifa iniciada! Preparando a roleta!",
        sorteoEnCurso: "Em Andamento",
        sorteoFinalizado: "Finalizado",
        sorteoCompletado: "Completado",
        
        iniciar: "üöÄ Iniciar",
        sorteo: "üé≤ Rifa",
        reiniciar: "üîÑ Resetar",
        girando: "üé≤ Girando...",
        
        subastaFinalizadaNoDonaciones: "üîí Leil√£o finalizado - N√£o aceitamos mais doa√ß√µes",
        
        // Otros textos
        diamantes: ""
      },
      
      tagalo: {
        esperandoDonaciones: "Naghihintay ng mga donasyon para magsimula...",
        subastaEnCurso: "Subasta na nagaganap - Magpadala ng mga regalo!",
        subastaPausada: "Subasta na naka-pause",
        subastaFinalizada: "NATAPOS ANG SUBASTA!",
        tiempoPorDelay: "Oras para sa live delay",
        finalizado: "NATAPOS",
        montminimo: "pinakamababang halaga",
        
        tiempoSnipeActivo: "AKTIBO ANG ORAS NG DELAY!",
        noDonesMas: "‚ö†Ô∏è KUNG NAKIKITA MO ANG TIMER SA 0:00 HUWAG KA NANG MAG-DONATE ‚ö†Ô∏è",
        tiempoSnipeFinalizado: "NATAPOS ANG ORAS NG DELAY!",
        
        ganador: "NANALO!",
        empate: "PATAS!",
        ambosGanadores: "Pareho silang nanalo!",
        felicidades: "Binabati kita!",
        seVieneDesempate: "Darating ang tiebreaker!",
        
        top10Donadores: "TOP 10 MGA NAG-DONATE",
        topFinalSubasta: "FINAL TOP - NATAPOS ANG SUBASTA",
        podioFinal: "üèÜ FINAL PODIUM",
        participantes: "MGA KASALI",
        ticketsTotales: "Kabuuang Tickets",
        totalParticipantes: "Kabuuang mga kasali:",
        
        esperandoIniciar: "Walang nag-donate pa. Magsisimula ang subasta kapag na-initiate.",
        esperandoDonaciones: "Naghihintay ng mga donasyon...",
        sorteoIniciado: "Nagsimula ang raffle! Inihahanda ang gulong!",
        sorteoEnCurso: "Nagaganap",
        sorteoFinalizado: "Natapos",
        sorteoCompletado: "Nakumpleto",
        
        iniciar: "üöÄ Simulan",
        sorteo: "üé≤ Raffle",
        reiniciar: "üîÑ I-reset",
        girando: "üé≤ Umiikot...",
        
        subastaFinalizadaNoDonaciones: "üîí Natapos ang subasta - Hindi na tumatanggap ng mga donasyon",
        
        // Otros textos
        diamantes: ""
      },
      
      indonesio: {
        esperandoDonaciones: "Menunggu donasi untuk memulai...",
        subastaEnCurso: "Lelang sedang berlangsung - Kirim hadiah!",
        subastaPausada: "Lelang dijeda",
        subastaFinalizada: "LELANG SELESAI!",
        tiempoPorDelay: "Waktu untuk delay live",
        finalizado: "SELESAI",
        montminimo: "jumlah minimum",
        
        tiempoSnipeActivo: "WAKTU DELAY AKTIF!",
        noDonesMas: "‚ö†Ô∏è JIKA ANDA MELIHAT TIMER DI 0:00 JANGAN DONASI LAGI ‚ö†Ô∏è",
        tiempoSnipeFinalizado: "WAKTU DELAY SELESAI!",
        
        ganador: "PEMENANG!",
        empate: "SERI!",
        ambosGanadores: "Keduanya adalah pemenang!",
        felicidades: "Selamat!",
        seVieneDesempate: "Tiebreaker akan datang!",
        
        top10Donadores: "TOP 10 DONATUR",
        topFinalSubasta: "TOP FINAL - LELANG SELESAI",
        podioFinal: "üèÜ PODIUM FINAL",
        participantes: "PESERTA",
        ticketsTotales: "Total Tiket",
        totalParticipantes: "Total peserta:",
        
        esperandoIniciar: "Belum ada donatur. Lelang akan dimulai saat diinisiasi.",
        esperandoDonaciones: "Menunggu donasi...",
        sorteoIniciado: "Raffle dimulai! Menyiapkan roda!",
        sorteoEnCurso: "Sedang Berlangsung",
        sorteoFinalizado: "Selesai",
        sorteoCompletado: "Selesai",
        
        iniciar: "üöÄ Mulai",
        sorteo: "üé≤ Raffle",
        reiniciar: "üîÑ Reset",
        girando: "üé≤ Berputar...",
        
        subastaFinalizadaNoDonaciones: "üîí Lelang selesai - Tidak menerima donasi lagi",
        
        // Otros textos
        diamantes: ""
      },
      
      vietnamita: {
        esperandoDonaciones: "ƒêang ch·ªù quy√™n g√≥p ƒë·ªÉ b·∫Øt ƒë·∫ßu...",
        subastaEnCurso: "Phi√™n ƒë·∫•u gi√° ƒëang di·ªÖn ra - G·ª≠i qu√†!",
        subastaPausada: "Phi√™n ƒë·∫•u gi√° t·∫°m d·ª´ng",
        subastaFinalizada: "PHI√äN ƒê·∫§U GI√Å HO√ÄN TH√ÄNH!",
        tiempoPorDelay: "Th·ªùi gian cho ƒë·ªô tr·ªÖ tr·ª±c ti·∫øp",
        finalizado: "HO√ÄN TH√ÄNH",
        montminimo: "s·ªë ti·ªÅn t·ªëi thi·ªÉu",
        
        tiempoSnipeActivo: "TH·ªúI GIAN ƒê·ªò TR·ªÑ ƒêANG HO·∫†T ƒê·ªòNG!",
        noDonesMas: "‚ö†Ô∏è N·∫æU B·∫†N TH·∫§Y TIMER ·ªû 0:00 ƒê·ª™NG QUY√äN G√ìP N·ªÆA ‚ö†Ô∏è",
        tiempoSnipeFinalizado: "TH·ªúI GIAN ƒê·ªò TR·ªÑ HO√ÄN TH√ÄNH!",
        
        ganador: "NG∆Ø·ªúI TH·∫ÆNG!",
        empate: "H√íA!",
        ambosGanadores: "C·∫£ hai ƒë·ªÅu l√† ng∆∞·ªùi th·∫Øng!",
        felicidades: "Ch√∫c m·ª´ng!",
        seVieneDesempate: "Tr·∫≠n ƒë·∫•u quy·∫øt ƒë·ªãnh s·∫Øp ƒë·∫øn!",
        
        top10Donadores: "TOP 10 NG∆Ø·ªúI QUY√äN G√ìP",
        topFinalSubasta: "TOP CU·ªêI - PHI√äN ƒê·∫§U GI√Å HO√ÄN TH√ÄNH",
        podioFinal: "üèÜ PODIUM CU·ªêI",
        participantes: "NG∆Ø·ªúI THAM GIA",
        ticketsTotales: "T·ªïng V√©",
        totalParticipantes: "T·ªïng ng∆∞·ªùi tham gia:",
        
        esperandoIniciar: "Ch∆∞a c√≥ ng∆∞·ªùi quy√™n g√≥p. Phi√™n ƒë·∫•u gi√° s·∫Ω b·∫Øt ƒë·∫ßu khi ƒë∆∞·ª£c kh·ªüi t·∫°o.",
        esperandoDonaciones: "ƒêang ch·ªù quy√™n g√≥p...",
        sorteoIniciado: "X·ªï s·ªë b·∫Øt ƒë·∫ßu! ƒêang chu·∫©n b·ªã b√°nh xe!",
        sorteoEnCurso: "ƒêang Di·ªÖn Ra",
        sorteoFinalizado: "Ho√†n Th√†nh",
        sorteoCompletado: "Ho√†n Th√†nh",
        
        iniciar: "üöÄ B·∫Øt ƒê·∫ßu",
        sorteo: "üé≤ X·ªï S·ªë",
        reiniciar: "üîÑ ƒê·∫∑t L·∫°i",
        girando: "üé≤ ƒêang Quay...",
        
        subastaFinalizadaNoDonaciones: "üîí Phi√™n ƒë·∫•u gi√° ho√†n th√†nh - Kh√¥ng nh·∫≠n quy√™n g√≥p n·ªØa",
        
        // Otros textos
        diamantes: ""
      },

      italiano:{
        // Estados y mensajes principales
        esperandoDonaciones: "In attesa di donazioni per iniziare...",
        subastaEnCurso: "Asta in corso - Invia regali!",
        subastaPausada: "Asta in pausa",
        subastaFinalizada: "ASTA TERMINATA!",
        tiempoPorDelay: "Tempo per il ritardo live",
        finalizado: "TERMINATO",
        montminimo: "importo minimo",
        // Mensajes de snipe/delay
        tiempoSnipeActivo: "TEMPO DI RITARDO ATTIVO!",
        noDonesMas: "‚ö†Ô∏è SE VEDI IL TIMER A 0:00 NON DONARE PI√ô ‚ö†Ô∏è",
        tiempoSnipeFinalizado: "TEMPO DI RITARDO TERMINATO!",
        
        // Mensajes de ganador
        ganador: "VINCITORE!",
        empate: "PAREGGIO!",
        ambosGanadores: "Entrambi sono vincitori!",
        felicidades: "Congratulazioni!",
        seVieneDesempate: "Sta arrivando lo spareggio!",
        
        // T√≠tulos y etiquetas
        top10Donadores: "TOP 10 DONATORI",
        topFinalSubasta: "TOP FINALE - ASTA COMPLETATA",
        podioFinal: "üèÜ PODIO FINALE",
        participantes: "PARTECIPANTI",
        ticketsTotales: "Biglietti Totali",
        totalParticipantes: "Totale partecipanti:",
        
        // Mensajes de estado
        esperandoIniciar: "Non ci sono ancora donatori. L'asta inizier√† quando verr√† avviata.",
        esperandoDonaciones: "In attesa di donazioni...",
        sorteoIniciado: "Estrazione iniziata! Preparando la ruota!",
        sorteoEnCurso: "In Corso",
        sorteoFinalizado: "Terminato",
        sorteoCompletado: "Completato",
        
        // Botones
        iniciar: "üöÄ Inizia",
        sorteo: "üé≤ Estrazione",
        reiniciar: "üîÑ Reimposta",
        girando: "üé≤ Girando...",
        
        // Mensajes de bloqueo
        subastaFinalizadaNoDonaciones: "üîí Asta terminata - Non si accettano pi√π donazioni",
        
        // Otros textos
        diamantes: ""
      }
    };
    
    // Funci√≥n para obtener el idioma actual
    function obtenerIdioma() {
      return window.lenguageWidget || 'espanol';
    }
    
    // Funci√≥n para obtener texto traducido
    function t(key) {
      const idioma = obtenerIdioma();
      return idiomasWidget[idioma]?.[key] || idiomasWidget.espanol[key] || key;
    }
    
    // Datos de prueba para simular donadores
    let donadores = [
      
    ];

    // Timer de prueba
    let tiempoRestante = 0; // Cambiado de 60 a 0
    let tiempoRestanteSnipe = 0; // Cambiado de 60 a 0
    let minimoDonacion = 0;
    let timerInterval;
    let timerIntervalSnipe;
    let subastaFinalizada = false;
    let subastaFinalizadaSnipe = false;
    let subastaIniciada = false; // Nueva variable para controlar si la subasta ha sido iniciada
    let pausado = false; // Variable para controlar si el timer est√° pausado
    let modificandoTiempo = false; // Variable para evitar que el timer interfiera cuando se modifica tiempo manualmente
    let tiempoSnipe = 0; // Variable para controlar el tiempo de snipe
    let snipeActivo = false; // Variable para controlar si el tiempo snipe est√° activo
    
    // Variables para el sistema de tiempo snipe mejorado
    let topFinalizado = false; // Indica si el top final ya se mostr√≥
    let tiempoSnipeConfigurado = 5000; // 5 segundos por defecto
    let donacionesBloqueadas = false; // Indica si se pueden aceptar m√°s donaciones

                   // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      inicializarRanking();
      inicializarSocket();      
      // Marcar widget como inicializado
      widgetInicializado = true;
    });

    window.addEventListener("message", (event) => {
      console.log("Mensaje recibido de la p√°gina principal:", event.data);
      event.source.postMessage("frameloaded", event.origin);
    });
    
    var SOCKET_IDENTIFICADOR = "wsSubasta1";
    var socket = null;
    function inicializarSocket() {
    socket = io('http://localhost:8081', {
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
    });
    socket.on('connect', () => {
        socket.emit('newIdentifica', { config:{socketTipo: SOCKET_IDENTIFICADOR} });
      })
      // Escuchar el evento 'mensaje' del socket
      socket.on('mensaje', (valores) => {
        console.log('üì© Mensaje recibido por socket:', valores);
        // Verificar si la subasta ya ha finalizado (incluyendo snipe)
        if (subastaFinalizada && subastaFinalizadaSnipe) {
          console.log('‚ö†Ô∏è Subasta finalizada y snipe finalizado. Ignorando mensaje.');
          return;
        }

        // Procesar el mensaje de donaci√≥n para el top de donadores
        if (valores && valores.funcion === 'mensaje' && valores.diamantes) {
          console.log('üéÅ Procesando donaci√≥n recibida:', valores);
          procesarDonacion(valores);
        } else {
          console.log('‚ÑπÔ∏è Mensaje recibido no es una donaci√≥n v√°lida o no contiene diamantes:', valores);
        }
      })
      socket.on('iniciarSubasta', (valores) => {
        console.log("üì° Comando iniciarSubasta recibido:", valores);
        console.log("üîß Debug - tiempoSnipe recibido:", valores.tiempoSnipe);
        console.log("üåç Debug - idioma recibido:", valores.lenguage);
        // Configurar idioma del widget
        if (valores.lenguage) {
          window.lenguageWidget = valores.lenguage;
          console.log("üåç Idioma del widget configurado:", window.lenguageWidget);
          
          // Actualizar textos del widget al nuevo idioma
          actualizarIdiomaWidget();
        }
        if (valores.minimo) {
          if (valores.minimo > 0) {
            document.getElementById("labelminimo").style.display = "block";
          } else {
            document.getElementById("labelminimo").style.display = "none";
          }
          document.getElementById("labelminimo").innerText = `${idiomasWidget[obtenerIdioma()].montminimo} ${valores.minimo}`;

        }
        iniciarSubastaDesdeComando(valores.tiempoInicial || 60, valores.tiempoSnipe || 0, valores.minimo || 0);
      });
      socket.on('pausarSubasta', (valores) => {
        // Solo ejecutar si el widget est√° inicializado
        if (widgetInicializado) {
          // Si no hay valores espec√≠ficos, hacer toggle autom√°tico
          if (!valores || valores.pausada === undefined) {
            pausarSubastaDesdeComando(); // Sin par√°metros = toggle autom√°tico
          } else {
            // Si hay valores espec√≠ficos, usar el valor de pausada
            const debePausar = valores.pausada === true;
            const estadoActual = pausado;            
            // Solo ejecutar si el estado es diferente
            if (debePausar !== estadoActual) {
              pausarSubastaDesdeComando(debePausar);
            }
          }
        }
      });
      socket.on('finalizarSubasta', (valores) => {
        console.log('üèÅ Comando finalizarSubasta recibido por socket');
        // Limpiar timer principal
        clearInterval(timerInterval);
        // Marcar subasta como finalizada
        subastaFinalizada = true;
        subastaFinalizadaSnipe = true;
        mostrarTopFinal();
      });
      socket.on('modificarpuntos', (valores) => {
        console.log('üîÑ Comando modificarpuntos recibido por socket:', valores);
        // donadores.forEach(donador => {
        //   if (donador.id === valores.userId){
        //     donador.total_diamantes += valores.puntos;
        //   }
        // })
        const {
          uniqueId,           // ID √∫nico del usuario
          diamondCount,       // Cantidad de diamantes de esta donaci√≥n
          repeatCount,        // Cantidad de veces que se repite el regalo
        } = valores;
        console.log(valores)
        procesarDonacion(valores)
      });
      socket.on('restart', (valores) => {
        restartWidget();
      });
      socket.on('modificarTiempo', (valores) => {
        if (subastaFinalizada && subastaFinalizadaSnipe) {
          console.log('‚ö†Ô∏è Subasta finalizada y snipe finalizado. Ignorando mensaje.');
          return;
        }
        modificarTiempoDesdeComando(valores.segundos, valores.tipo);
      });
      // widget:wsWiner-operar-mas-1 
      socket.on('operar', (valores) => {
        if (subastaFinalizada && subastaFinalizadaSnipe) {
          console.log('‚ö†Ô∏è Subasta finalizada y snipe finalizado. Ignorando mensaje.');
          return;
        }
        
        var monto = valores.valor;        
        // Procesar el monto para sumar o restar tiempo
        if (monto > 0) {
          // Monto positivo: sumar tiempo
          modificarTiempoDesdeComando(monto, 'sumar');
        } else if (monto < 0) {
          // Monto negativo: restar tiempo
          const segundosRestar = Math.abs(monto);
          modificarTiempoDesdeComando(segundosRestar, 'restar');
        }
      })

    }

    function restartWidget() {
      // console.log('üîÑ Reiniciando widget...');
      // Aqu√≠ puedes agregar la l√≥gica de reinicio del widget, como recargar la p√°gina o resetear estados
      // Por ahora, simplemente recargar la p√°gina para simular un reinicio completo
      location.reload();
    }

    function inicializarRanking() {
      // No inicializar si la subasta ya est√° finalizada
      if (subastaFinalizada && subastaFinalizadaSnipe) {
        console.log('üîß Debug - inicializarRanking - Subasta ya finalizada, saltando inicializaci√≥n');
        return;
      }
      actualizarRanking();
    }

    function actualizarRanking() {
      const rankingElement = document.getElementById('ranking');
      const rankingTitle = document.getElementById('rankingTitle');
      
      // Asegurar que no se muestre el podio final si la subasta no est√° finalizada
      console.log('üîß Debug - actualizarRanking - subastaFinalizada:', subastaFinalizada, 'subastaFinalizadaSnipe:', subastaFinalizadaSnipe);
      if (subastaFinalizada && subastaFinalizadaSnipe) {
        console.log('üîß Debug - actualizarRanking - Mostrando top 3 final');
        // Mostrar solo top 3 con √©nfasis especial
        mostrarTop3Final();
        return;
      }
      
      // Si no hay donadores y la subasta no ha iniciado, mostrar mensaje
      if (donadores.length === 0 && !subastaIniciada) {
        rankingElement.className = 'ranking';
        rankingTitle.textContent = t('top10Donadores');
        rankingElement.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">' + t('esperandoIniciar') + '</div>';
        return;
      }
      
      // Si no hay donadores pero la subasta est√° en curso, mostrar mensaje
      if (donadores.length === 0 && subastaIniciada) {
        rankingElement.className = 'ranking';
        rankingTitle.textContent = t('top10Donadores');
        rankingElement.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">' + t('esperandoDonaciones') + '</div>';
        return;
      }
      
      // Mostrar top 10 normal
      console.log('üîß Debug - actualizarRanking - Mostrando top 10 normal con', donadores.length, 'donadores');
      rankingElement.className = 'ranking';
      rankingTitle.textContent = t('top10Donadores');
      rankingElement.innerHTML = '';

      donadores.forEach((donador, index) => {
        if (donador.total_diamantes < minimoDonacion) {
          return; // Saltar donadores que no alcanzan el m√≠nimo
        }
        const donadorElement = document.createElement('div');
        donadorElement.className = 'donador';
        donadorElement.dataset.id = donador.id;

        const positionClass = getPositionClass(index + 1);
        
        donadorElement.innerHTML = `
          <div class="position ${positionClass}">${index + 1}</div>
          <div class="foto" style="background-image: url('${donador.userfoto}')"></div>
          <div class="info">
            <div class="nombre">${donador.usernick}</div>
            <div class="diamantes">
              <div class="tiktok-coin">
                <svg font-size="30px" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><g clip-path="url(#Icon_Color-Tiktok_Coin_svg__a)"><path d="M48 24a24 24 0 1 1-48 0 24 24 0 0 1 48 0Z" fill="#FFB84D"></path><path d="M47 24a23 23 0 1 1-46 0 23 23 0 0 1 46 0Z" fill="#FFDE55"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A300"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A80F"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#E88B00"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#F09207"></path><path d="M34.74 17.77v5.86c-2.06 0-4.05-.44-5.81-1.55v7.2a7.79 7.79 0 0 1-7.84 7.75 7.79 7.79 0 0 1-7.8-8.35 7.79 7.79 0 0 1 9.19-8.24v6c-.47-.13-.9-.26-1.39-.26a3.14 3.14 0 0 0-3.09 2.5 3.14 3.14 0 0 0 3.1 2.5c1.74 0 3.14-1.4 3.14-3.11V12.03h4.69a5.6 5.6 0 0 0 5.81 5.74Z" fill="#F09207"></path><path d="M34.34 18.18a5.78 5.78 0 0 1-5.82-5.74h-3.87v15.63c0 1.94-1.6 3.5-3.56 3.5a3.53 3.53 0 0 1-3.55-3.5 3.53 3.53 0 0 1 4.52-3.38v-3.9a7.38 7.38 0 0 0-8.4 7.28 7.38 7.38 0 0 0 7.43 7.34c4.1 0 7.43-3.29 7.43-7.34v-7.98a9.73 9.73 0 0 0 5.82 1.92v-3.83Z" fill="#fff"></path></g><defs><clipPath id="Icon_Color-Tiktok_Coin_svg__a"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg>
              </div>
              ${donador.total_diamantes}
            </div>
          </div>
        `;

        rankingElement.appendChild(donadorElement);
      });
    }

    function mostrarTop3Final() {
      const rankingElement = document.getElementById('ranking');
      const rankingTitle = document.getElementById('rankingTitle');
      
      // Cambiar a layout de 1 columna y estilo finalizado
      rankingElement.className = 'ranking finalizado';
              rankingTitle.textContent = 'üèÜ ' + t('podioFinal');
      rankingElement.innerHTML = '';

      // Mostrar solo los 3 primeros
      const top3 = donadores.slice(0, 3);
      
      top3.forEach((donador, index) => {
        const donadorElement = document.createElement('div');
        donadorElement.className = 'donador';
        
        if (index === 0) {
          donadorElement.classList.add('ganador');
        }
        
        const positionClass = getPositionClass(index + 1);
        
        donadorElement.innerHTML = `
          <div class="position ${positionClass}">${index + 1}</div>
          <div class="foto" style="background-image: url('${donador.userfoto}')"></div>
          <div class="info">
            <div class="nombre">${donador.usernick}</div>
            <div class="diamantes">
              <div class="tiktok-coin">
                <svg font-size="30px" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><g clip-path="url(#Icon_Color-Tiktok_Coin_svg__a)"><path d="M48 24a24 24 0 1 1-48 0 24 24 0 0 1 48 0Z" fill="#FFB84D"></path><path d="M47 24a23 23 0 1 1-46 0 23 23 0 0 1 46 0Z" fill="#FFDE55"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A300"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A80F"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#E88B00"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#F09207"></path><path d="M34.74 17.77v5.86c-2.06 0-4.05-.44-5.81-1.55v7.2a7.79 7.79 0 0 1-7.84 7.75 7.79 7.79 0 0 1-7.8-8.35 7.79 7.79 0 0 1 9.19-8.24v6c-.47-.13-.9-.26-1.39-.26a3.14 3.14 0 0 0-3.09 2.5 3.14 3.14 0 0 0 3.1 2.5c1.74 0 3.14-1.4 3.14-3.11V12.03h4.69a5.6 5.6 0 0 0 5.81 5.74Z" fill="#F09207"></path><path d="M34.34 18.18a5.78 5.78 0 0 1-5.82-5.74h-3.87v15.63c0 1.94-1.6 3.5-3.56 3.5a3.53 3.53 0 0 1-3.55-3.5 3.53 3.53 0 0 1 4.52-3.38v-3.9a7.38 7.38 0 0 0-8.4 7.28 7.38 7.38 0 0 0 7.43 7.34c4.1 0 7.43-3.29 7.43-7.34v-7.98a9.73 9.73 0 0 0 5.82 1.92v-3.83Z" fill="#fff"></path></g><defs><clipPath id="Icon_Color-Tiktok_Coin_svg__a"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg>
              </div>
              ${donador.total_diamantes}
            </div>
          </div>
        `;

        rankingElement.appendChild(donadorElement);
      });
    }

    function getPositionClass(position) {
      if (position === 1) return 'position-1';
      if (position === 2) return 'position-2';
      if (position === 3) return 'position-3';
      return 'position-4-10';
    }

    function iniciarTimer() {
      // Limpiar cualquier intervalo anterior para evitar m√∫ltiples timers
      if (timerInterval) {
        // console.log('üßπ Limpiando timer anterior existente');
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerInterval = setInterval(() => {
        // No decrementar si est√° pausado, finalizado o modificando tiempo
        if (pausado || subastaFinalizada || modificandoTiempo) {
          return;
        }
        
        tiempoRestante--;
        actualizarTimer();
        
        if (tiempoRestante <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          finalizarSubasta();
        }
      }, 1000);
      
      // Aplicar color inicial verde al timer y borde del contenedor
      const timerElement = document.getElementById('timer');
      if (timerElement) {
        timerElement.style.color = '#4ecdc4';
        timerElement.style.textShadow = '0 0 20px rgba(78, 205, 196, 0.8)';
        timerElement.style.animation = 'none';
        timerElement.style.fontSize = '52px'; // Restaurar tama√±o normal del timer
        timerElement.classList.remove('finalizado'); // Remover clase de finalizado
        
        // Aplicar borde verde al contenedor
        const timerContainer = timerElement.closest('.timer-container');
        if (timerContainer) {
          timerContainer.style.borderColor = '#4ecdc4';
        }
      }
    }

    function actualizarTimer() {      
      // Verificar si el timer principal lleg√≥ a 0 y activar snipe (solo si tiempoSnipe > 0)
      if (tiempoRestante <= 0 && !snipeActivo && !subastaFinalizada) {
        console.log(`üîß Debug - Timer lleg√≥ a 0, tiempoSnipe: ${tiempoSnipe}s`);
        if (tiempoSnipe > 0) {
          console.log('üîß Debug - Activando tiempo de snipe...');
          activarTiempoSnipe();
        } else {
          console.log('üîß Debug - No hay tiempo de snipe, finalizando directamente...');
          // Si no hay tiempo de snipe, finalizar directamente
          finalizarSubasta();
        }
        return;
      }
      
      const minutos = Math.floor(tiempoRestante / 60);
      const segundos = tiempoRestante % 60;
      const tiempoFormateado = `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
      const timerElement = document.getElementById('timer');
      if (timerElement) {
        timerElement.textContent = tiempoFormateado;        
        // Cambiar color seg√∫n tiempo restante con sombras din√°micas
        if (tiempoRestante <= 10) {
          // ROJO: Tiempo cr√≠tico (‚â§10 segundos)
          timerElement.style.color = '#ff0000';
          timerElement.style.textShadow = '0 0 20px rgba(255, 0, 0, 0.8)';
          timerElement.style.animation = 'pulse 1s infinite';
          
          // Actualizar borde del contenedor
          const timerContainer = timerElement.closest('.timer-container');
          if (timerContainer) {
            timerContainer.style.borderColor = '#ff0000';
          }
        } else if (tiempoRestante <= 20) {
          // AMARILLO: Tiempo de advertencia (11-20 segundos)
          timerElement.style.color = '#f8cb00';
          timerElement.style.textShadow = '0 0 20px rgba(248, 203, 0, 0.8)';
          timerElement.style.animation = 'none';
          
          // Actualizar borde del contenedor
          const timerContainer = timerElement.closest('.timer-container');
          if (timerContainer) {
            timerContainer.style.borderColor = '#f8cb00';
          }
        } else {
          // VERDE: Tiempo normal (>20 segundos)
          timerElement.style.color = '#4ecdc4';
          timerElement.style.textShadow = '0 0 20px rgba(78, 205, 196, 0.8)';
          timerElement.style.animation = 'none';
          
          // Actualizar borde del contenedor
          const timerContainer = timerElement.closest('.timer-container');
          if (timerContainer) {
            timerContainer.style.borderColor = '#4ecdc4';
          }
        }
      } else {
        console.error('‚ùå Elemento timer no encontrado en el DOM');
      }
    }

    function actualizarTimerSnipe() {
      console.log(`‚è±Ô∏è actualizarTimerSnipe() - tiempoRestanteSnipe: ${tiempoRestanteSnipe}s`);
      
      // Formatear tiempo para mostrar solo segundos (ya que el snipe es corto)
      const tiempoFormateado = `${tiempoRestanteSnipe}s`;
      
      console.log(`‚è±Ô∏è Tiempo snipe formateado: ${tiempoFormateado}`);
      
      // ACTUALIZAR SOLO EL DELAY TIMER CON EL TIEMPO DE SNIPE
      const delayTimerElement = document.getElementById('delaytimer');
      if (delayTimerElement) {
        delayTimerElement.textContent = tiempoFormateado;
        console.log(`‚úÖ Delay timer actualizado: ${tiempoFormateado}`);
        
        // Aplicar colores y animaciones seg√∫n el tiempo restante
        if (tiempoRestanteSnipe <= 2) {
          delayTimerElement.style.color = '#ff0000';
          delayTimerElement.style.animation = 'pulse 0.5s infinite';
        } else if (tiempoRestanteSnipe <= 3) {
          delayTimerElement.style.color = '#ff6b6b';
          delayTimerElement.style.animation = 'parpadeoSnipe 1s infinite';
        } else {
          delayTimerElement.style.color = '#ff6b6b';
          delayTimerElement.style.animation = 'parpadeoSnipe 1s infinite';
        }
      } else {
        console.error('‚ùå Elemento delaytimer no encontrado en el DOM');
      }
      
      // EL TIMER PRINCIPAL SE MANTIENE EN 0:00
      const timerElement = document.getElementById('timer');
      if (timerElement) {
        // Mantener el timer principal en 0:00 con estilo de advertencia
        timerElement.textContent = '0:00';
        timerElement.style.color = '#ff0000';
        timerElement.style.fontWeight = 'bold';
        timerElement.style.textShadow = '0 0 20px rgba(255, 0, 0, 0.8)';
        timerElement.style.animation = 'parpadeoSnipe 1s infinite';
      }
    }

    function iniciarTimerSnipe() {
      console.log('üöÄ iniciarTimerSnipe() llamado');
      console.log(`üîß Estado inicial - tiempoRestanteSnipe: ${tiempoRestanteSnipe}s`);
      
      // Limpiar cualquier intervalo anterior para evitar m√∫ltiples timers
      if (timerIntervalSnipe) {
        console.log('üßπ Limpiando timer anterior existente');
        clearInterval(timerIntervalSnipe);
        timerIntervalSnipe = null;
      }
      
      // Verificar que el tiempo sea v√°lido
      if (tiempoRestanteSnipe <= 0) {
        console.error('‚ùå Tiempo de snipe inv√°lido:', tiempoRestanteSnipe);
        console.log('üîß Intentando corregir tiempo de snipe...');
        
        // Intentar corregir el tiempo
        if (tiempoSnipe > 0) {
          tiempoRestanteSnipe = tiempoSnipe;
          console.log(`üîß Tiempo corregido a: ${tiempoRestanteSnipe}s`);
        } else {
          tiempoRestanteSnipe = 5;
          console.log(`üîß Tiempo establecido por defecto: ${tiempoRestanteSnipe}s`);
        }
      }
      
      console.log(`‚è±Ô∏è Creando nuevo timer de snipe con ${tiempoRestanteSnipe}s`);
      timerIntervalSnipe = setInterval(() => {
        // No decrementar si est√° finalizado
        if (subastaFinalizadaSnipe) {
          console.log('‚èπÔ∏è Timer de snipe detenido - subasta finalizada');
          return;
        }
        
        // Decrementar tiempo
        tiempoRestanteSnipe--;
        console.log(`‚è∞ Timer snipe: ${tiempoRestanteSnipe}s restantes`);
        
        // Actualizar display
        actualizarTimerSnipe();
        
        // Verificar si termin√≥
        if (tiempoRestanteSnipe <= 0) {
          console.log('üèÅ Timer de snipe terminado, finalizando subasta...');
          clearInterval(timerIntervalSnipe);
          timerIntervalSnipe = null;
          finalizarSubastaSnipe();
        }
      }, 1000);
      
      console.log('‚úÖ Timer de snipe iniciado correctamente');
    }

    function finalizarSubastaSnipe(){
      console.log('üèÅ ¬°TIEMPO SNIPE FINALIZADO!');
      
      subastaFinalizadaSnipe = true;
      snipeActivo = false;
      topFinalizado = true;
      donacionesBloqueadas = true;
      
      // Ocultar mensaje de snipe
      const mensajeSnipe = document.getElementById('mensajeSnipe');
      if (mensajeSnipe) {
        mensajeSnipe.remove();
      }
      
      // OCULTAR EL DELAY TIMER CUANDO TERMINE EL SNIPE
      const delayTimerContainer = document.getElementById('delaytimercontainer');
      if (delayTimerContainer) {
        delayTimerContainer.style.display = 'none';
      }
      
      // Restaurar timer principal
      const timerElement = document.getElementById('timer');
      if (timerElement) {
        timerElement.style.color = '#ffd700';
        timerElement.style.fontWeight = '900';
        timerElement.style.textShadow = 'none';
        timerElement.style.animation = 'none';
        timerElement.style.fontSize = '40px'; // Reducir tama√±o para que quepa "FINALIZADO"
        timerElement.textContent = 'üèÅ FINALIZADO';
        timerElement.classList.add('finalizado'); // Agregar clase CSS para estilos espec√≠ficos
      }
      
      // Cambiar estado final
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.textContent = 'üèÅ ¬°SUBASTA FINALIZADA! Top final mostrado';
        statusElement.style.color = '#ffd700';
        statusElement.style.fontWeight = 'bold';
        statusElement.style.background = 'rgba(255, 215, 0, 0.1)';
        statusElement.style.borderColor = 'rgba(255, 215, 0, 0.5)';
      }
      
      // Mostrar top final
      mostrarTopFinal();
      
            console.log('‚úÖ Subasta completamente finalizada');
    }
    
    // Funci√≥n para mostrar el top final
    function mostrarTopFinal() {
      // Protecci√≥n contra ejecuciones m√∫ltiples
      if (window.topFinalEnProceso) {
        console.log('‚ö†Ô∏è mostrarTopFinal ya est√° en proceso, saltando ejecuci√≥n');
        return;
      }
      
      window.topFinalEnProceso = true;
      console.log('üèÜ Mostrando top final de la subasta - Stack trace:', new Error().stack);
      
      // Ordenar participantes finales por total de diamantes
      const topFinal = [...donadores].sort((a, b) => b.total_diamantes - a.total_diamantes);
      // socket.emit('ganador', topFinal[0]); // Enviar top final al servidor

      socket.emit("conexion_widgets", {
        widget: SOCKET_IDENTIFICADOR,
        comando: "registrar_ganador",
        valores: topFinal[0]
      });

      // Aplicar clase de finalizaci√≥n al ranking
      const rankingElement = document.getElementById('ranking');
      if (rankingElement) {
        rankingElement.classList.add('finalizado');
        rankingElement.style.border = '3px solid #ffd700';
        rankingElement.style.boxShadow = '0 0 20px rgba(255, 215, 0, 0.6)';
      }
      
      // Actualizar t√≠tulo del ranking
      const rankingTitle = document.getElementById('rankingTitle');
      if (rankingTitle) {
        rankingTitle.innerHTML = 'üèÜ ' + t('topFinalSubasta');
        rankingTitle.style.color = '#ffd700';
        rankingTitle.style.fontWeight = 'bold';
      }
      
      // Primero mostrar animaci√≥n del ganador o empate
      if (topFinal.length > 0) {
        console.log('üîß Debug - mostrarTopFinal - Verificando si hay empate...');
        
        // Verificar si hay empate entre el primer y segundo puesto
        console.log('üîß Debug - mostrarTopFinal - Verificando empate:');
        console.log('  - Primer puesto:', topFinal[0].usernick, 'con', topFinal[0].total_diamantes, 'diamantes');
        if (topFinal.length > 1) {
          console.log('  - Segundo puesto:', topFinal[1].usernick, 'con', topFinal[1].total_diamantes, 'diamantes');
          console.log('  - ¬øEmpate?', topFinal[0].total_diamantes === topFinal[1].total_diamantes);
        }
        
        if (topFinal.length > 1 && topFinal[0].total_diamantes === topFinal[1].total_diamantes) {
          console.log('üîß Debug - mostrarTopFinal - ¬°EMPATE detectado! Mostrando animaci√≥n de empate');
          mostrarAnimacionEmpate([topFinal[0], topFinal[1]], () => {
            // Despu√©s de la animaci√≥n, mostrar el top 3
            mostrarTopConAnimacion(topFinal);
            // Bloquear interfaz para m√°s donaciones
            bloquearInterfaz();
          });
        } else {
          console.log('üîß Debug - mostrarTopFinal - No hay empate, mostrando animaci√≥n del ganador');
          mostrarAnimacionGanador(topFinal[0], () => {
            // Despu√©s de la animaci√≥n, mostrar el top 3
            mostrarTopConAnimacion(topFinal);
            // Bloquear interfaz para m√°s donaciones
            bloquearInterfaz();
          });
        }
      } else {
        // Si no hay ganadores, mostrar top directamente
        console.log('üîß Debug - mostrarTopFinal - No hay ganadores, mostrando top directamente');
        mostrarTopConAnimacion(topFinal);
        // Bloquear interfaz para m√°s donaciones
        bloquearInterfaz();
      }
      
      console.log('‚úÖ Top final mostrado correctamente');
      
      // Liberar bandera de control
      setTimeout(() => {
        window.topFinalEnProceso = false;
        console.log('üîß Debug - mostrarTopFinal - Bandera liberada');
      }, 2000);
    }
    
    // Funci√≥n para mostrar animaci√≥n del ganador
    function mostrarAnimacionGanador(ganador, callback) {
      console.log('üéâ Mostrando animaci√≥n del ganador:', ganador.usernick);
      
      // Guardar informaci√≥n del ganador para actualizaci√≥n de idioma
      window.ganadorActual = ganador;
      
      // Crear contenedor de animaci√≥n
      const animacionContainer = document.createElement('div');
      animacionContainer.id = 'animacionGanador';
      animacionContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: aparecerFondo 0.5s ease-out;
        overflow: hidden;
      `;
      
      // Crear contenido de la animaci√≥n
      const contenidoAnimacion = document.createElement('div');
      contenidoAnimacion.style.cssText = `
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #000;
        padding: 40px;
        border-radius: 25px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: aparecerGanador 0.8s ease-out;
        max-width: 500px;
        width: 90%;
        position: relative;
        z-index: 10;
      `;
      
      contenidoAnimacion.innerHTML = `
        <div style="font-size: 48px; font-weight: 900; margin-bottom: 20px; animation: bounce 1s infinite;">üèÜ</div>
        <div style="font-size: 32px; font-weight: 900; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          ${t('ganador')}
        </div>
        <div style="font-size: 24px; font-weight: 900; margin-bottom: 20px; color: #8B0000;">
          ${ganador.usernick}
        </div>
        <div style="font-size: 20px; font-weight: 900; margin-bottom: 15px; background: rgba(255,255,255,0.3); padding: 10px; border-radius: 10px;">
          <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#Icon_Color-Tiktok_Coin_svg__a)"><path d="M48 24a24 24 0 1 1-48 0 24 24 0 0 1 48 0Z" fill="#FFB84D"></path><path d="M47 24a23 23 0 1 1-46 0 23 23 0 0 1 46 0Z" fill="#FFDE55"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A300"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A80F"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#E88B00"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#F09207"></path><path d="M34.74 17.77v5.86c-2.06 0-4.05-.44-5.81-1.55v7.2a7.79 7.79 0 0 1-7.84 7.75 7.79 7.79 0 0 1-7.8-8.35 7.79 7.79 0 0 1 9.19-8.24v6c-.47-.13-.9-.26-1.39-.26a3.14 3.14 0 0 0-3.09 2.5 3.14 3.14 0 0 0 3.1 2.5c1.74 0 3.14-1.4 3.14-3.11V12.03h4.69a5.6 5.6 0 0 0 5.81 5.74Z" fill="#F09207"></path><path d="M34.34 18.18a5.78 5.78 0 0 1-5.82-5.74h-3.87v15.63c0 1.94-1.6 3.5-3.56 3.5a3.53 3.53 0 0 1-3.55-3.5 3.53 3.53 0 0 1 4.52-3.38v-3.9a7.38 7.38 0 0 0-8.4 7.28 7.38 7.38 0 0 0 7.43 7.34c4.1 0 7.43-3.29 7.43-7.34v-7.98a9.73 9.73 0 0 0 5.82 1.92v-3.83Z" fill="#fff"></path></g><defs><clipPath id="Icon_Color-Tiktok_Coin_svg__a"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg> ${ganador.total_diamantes} ${t('diamantes')}
        </div>
        <div style="font-size: 20px; font-weight: 900; opacity: 0.8; margin-top: 20px;">
          üéâ ${t('felicidades')} üéâ
        </div>
      `;
      
      animacionContainer.appendChild(contenidoAnimacion);
      document.body.appendChild(animacionContainer);
      
      // Iniciar efectos de celebraci√≥n
      iniciarEfectosCelebracion(animacionContainer);
      
      // Actualizar idioma de la animaci√≥n si es necesario
      if (window.lenguageWidget && window.lenguageWidget !== 'espanol') {
        setTimeout(() => {
          actualizarIdiomaWidget();
        }, 100);
      }
      
      // Despu√©s de 3 segundos, desaparecer la animaci√≥n
      setTimeout(() => {
        console.log('‚è∞ Animaci√≥n del ganador terminada, desapareciendo...');
        
        // Detener efectos de celebraci√≥n
        detenerEfectosCelebracion();
        
        // Agregar animaci√≥n de salida
        animacionContainer.style.animation = 'desaparecerFondo 0.5s ease-in forwards';
        contenidoAnimacion.style.animation = 'desaparecerGanador 0.5s ease-in forwards';
        
        // Remover despu√©s de la animaci√≥n
        setTimeout(() => {
          if (animacionContainer.parentNode) {
            animacionContainer.parentNode.removeChild(animacionContainer);
          }
          console.log('‚úÖ Animaci√≥n del ganador removida');
          
          // Ejecutar callback para mostrar el top
          if (callback) callback();
        }, 500);
      }, 3000);
    }
    
    // Funci√≥n para mostrar animaci√≥n de empate
    function mostrarAnimacionEmpate(empatados, callback) {
      console.log('ü§ù Mostrando animaci√≥n de empate entre:', empatados.map(e => e.usernick).join(' y '));
      
      // Guardar informaci√≥n de los empatados para actualizaci√≥n de idioma
      window.empatadosActuales = empatados;
      
      // Crear contenedor de animaci√≥n
      const animacionContainer = document.createElement('div');
      animacionContainer.id = 'animacionEmpate';
      animacionContainer.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: aparecerFondo 0.5s ease-out;
        overflow: hidden;
      `;
      
      // Crear contenido de la animaci√≥n
      const contenidoAnimacion = document.createElement('div');
      contenidoAnimacion.style.cssText = `
        background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
        color: #fff;
        padding: 40px;
        border-radius: 25px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: aparecerGanador 0.8s ease-out;
        max-width: 600px;
        width: 90%;
        position: relative;
        z-index: 10;
      `;
      
      contenidoAnimacion.innerHTML = `
        <div style="font-size: 48px; font-weight: 900; margin-bottom: 20px; animation: bounce 1s infinite;">ü§ù</div>
        <div style="font-size: 32px; font-weight: 900; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
          ${t('empate')}
        </div>
        <div style="font-size: 24px; font-weight: 900; margin-bottom: 20px; color: #ffd700;">
          ${empatados.map(e => e.usernick).join(' y ')}
        </div>
        <div style="font-size: 20px; font-weight: 900; margin-bottom: 15px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
          <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#Icon_Color-Tiktok_Coin_svg__a)"><path d="M48 24a24 24 0 1 1-48 0 24 24 0 0 1 48 0Z" fill="#FFB84D"></path><path d="M47 24a23 23 0 1 1-46 0 23 23 0 0 1 46 0Z" fill="#FFDE55"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A300"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 0 1 36 0Z" fill="#F7A80F"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#E88B00"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#F09207"></path><path d="M34.74 17.77v5.86c-2.06 0-4.05-.44-5.81-1.55v7.2a7.79 7.79 0 0 1-7.84 7.75 7.79 7.79 0 0 1-7.8-8.35 7.79 7.79 0 0 1 9.19-8.24v6c-.47-.13-.9-.26-1.39-.26a3.14 3.14 0 0 0-3.09 2.5 3.14 3.14 0 0 0 3.1 2.5c1.74 0 3.14-1.4 3.14-3.11V12.03h4.69a5.6 5.6 0 0 0 5.81 5.74Z" fill="#F09207"></path><path d="M34.34 18.18a5.78 5.78 0 0 1-5.82-5.74h-3.87v15.63c0 1.94-1.6 3.5-3.56 3.5a3.53 3.53 0 0 1-3.55-3.5 3.53 3.53 0 0 1 4.52-3.38v-3.9a7.38 7.38 0 0 0-8.4 7.28 7.38 7.38 0 0 0 7.43 7.34c4.1 0 7.43-3.29 7.43-7.34v-7.98a9.73 9.73 0 0 0 5.82 1.92v-3.83Z" fill="#fff"></path></g><defs><clipPath id="Icon_Color-Tiktok_Coin_svg__a"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg>
          ${empatados[0].total_diamantes} diamantes cada uno
        </div>
        <div style="font-size: 20px; font-weight: 900; opacity: 0.8; margin-top: 20px;">
          üéâ ${t('seVieneDesempate')} üéâ
        </div>
      `;
      
      animacionContainer.appendChild(contenidoAnimacion);
      document.body.appendChild(animacionContainer);
      
      // Iniciar efectos de celebraci√≥n
      iniciarEfectosCelebracion(animacionContainer);
      
      // Actualizar idioma de la animaci√≥n si es necesario
      if (window.lenguageWidget && window.lenguageWidget !== 'espanol') {
        setTimeout(() => {
          actualizarIdiomaWidget();
        }, 100);
      }
      
      // Despu√©s de 4 segundos, desaparecer la animaci√≥n (un poco m√°s que el ganador individual)
      setTimeout(() => {
        console.log('‚è∞ Animaci√≥n de empate terminada, desapareciendo...');
        
        // Detener efectos de celebraci√≥n
        detenerEfectosCelebracion();
        
        // Agregar animaci√≥n de salida
        animacionContainer.style.animation = 'desaparecerFondo 0.5s ease-in forwards';
        contenidoAnimacion.style.animation = 'desaparecerGanador 0.5s ease-in forwards';
        
        // Remover despu√©s de la animaci√≥n
        setTimeout(() => {
          if (animacionContainer.parentNode) {
            animacionContainer.parentNode.removeChild(animacionContainer);
          }
          console.log('‚úÖ Animaci√≥n de empate removida');
          
          // Ejecutar callback
          if (callback) callback();
        }, 500);
      }, 4000);
    }
    
    // Variables para efectos de celebraci√≥n
    let confetiInterval;
    let serpentinasInterval;
    let estrellasInterval;
    
    // Funci√≥n para iniciar efectos de celebraci√≥n
    function iniciarEfectosCelebracion(container) {
      console.log('üéä Iniciando efectos de celebraci√≥n...');
      
      // Iniciar confeti
      confetiInterval = setInterval(() => {
        crearConfeti(container);
      }, 100);
      
      // Iniciar serpentinas
      serpentinasInterval = setInterval(() => {
        crearSerpentina(container);
      }, 200);
      
      // Iniciar estrellas brillantes
      estrellasInterval = setInterval(() => {
        crearEstrella(container);
      }, 300);
    }
    
    // Funci√≥n para detener efectos de celebraci√≥n
    function detenerEfectosCelebracion() {
      console.log('üõë Deteniendo efectos de celebraci√≥n...');
      
      if (confetiInterval) clearInterval(confetiInterval);
      if (serpentinasInterval) clearInterval(serpentinasInterval);
      if (estrellasInterval) clearInterval(estrellasInterval);
    }
    
    // Funci√≥n para crear confeti
    function crearConfeti(container) {
      const confeti = document.createElement('div');
      const colores = ['#ff6b6b', '#4ecdc4', '#ffd700', '#9c27b0', '#ff9800', '#e91e63', '#2196f3'];
      const color = colores[Math.floor(Math.random() * colores.length)];
      
      confeti.style.cssText = `
        position: absolute;
        width: 8px;
        height: 8px;
        background: ${color};
        left: ${Math.random() * 100}%;
        top: -10px;
        z-index: 5;
        animation: confetiCaida 3s linear forwards;
        border-radius: 2px;
        box-shadow: 0 0 6px ${color};
      `;
      
      container.appendChild(confeti);
      
      // Remover confeti despu√©s de la animaci√≥n
      setTimeout(() => {
        if (confeti.parentNode) {
          confeti.parentNode.removeChild(confeti);
        }
      }, 3000);
    }
    
    // Funci√≥n para crear serpentinas
    function crearSerpentina(container) {
      const serpentina = document.createElement('div');
      const colores = ['#ffd700', '#ff6b6b', '#4ecdc4', '#9c27b0'];
      const color = colores[Math.floor(Math.random() * colores.length)];
      const lado = Math.random() > 0.5 ? 'left' : 'right';
      
      serpentina.style.cssText = `
        position: absolute;
        width: 3px;
        height: ${Math.random() * 100 + 50}px;
        background: linear-gradient(to bottom, ${color}, transparent);
        ${lado}: ${Math.random() * 100}%;
        top: -100px;
        z-index: 5;
        animation: serpentinaCaida 4s ease-in forwards;
        transform: rotate(${Math.random() * 360}deg);
        box-shadow: 0 0 8px ${color};
      `;
      
      container.appendChild(serpentina);
      
      // Remover serpentina despu√©s de la animaci√≥n
      setTimeout(() => {
        if (serpentina.parentNode) {
          serpentina.parentNode.removeChild(serpentina);
        }
      }, 4000);
    }
    
    // Funci√≥n para crear estrellas brillantes
    function crearEstrella(container) {
      const estrella = document.createElement('div');
      const posX = Math.random() * 100;
      const posY = Math.random() * 100;
      
      estrella.innerHTML = '‚≠ê';
      estrella.style.cssText = `
        position: absolute;
        font-size: ${Math.random() * 20 + 15}px;
        left: ${posX}%;
        top: ${posY}%;
        z-index: 5;
        animation: estrellaBrillo 2s ease-in-out infinite;
        filter: drop-shadow(0 0 10px #ffd700);
      `;
      
      container.appendChild(estrella);
      
      // Remover estrella despu√©s de un tiempo
      setTimeout(() => {
        if (estrella.parentNode) {
          estrella.parentNode.removeChild(estrella);
        }
      }, 4000);
    }
    
    // Funci√≥n para mostrar top con animaci√≥n
    function mostrarTopConAnimacion(topFinal) {
      // Protecci√≥n contra ejecuciones m√∫ltiples
      if (window.topConAnimacionEnProceso) {
        console.log('‚ö†Ô∏è mostrarTopConAnimacion ya est√° en proceso, saltando ejecuci√≥n');
        return;
      }
      
      window.topConAnimacionEnProceso = true;
      console.log('üîß Debug - mostrarTopConAnimacion - Iniciando con', topFinal.length, 'donadores - Stack trace:', new Error().stack);
      
      const rankingElement = document.getElementById('ranking');
      if (!rankingElement) {
        window.topConAnimacionEnProceso = false;
        return;
      }
      
      // Limpiar ranking anterior
      console.log('üîß Debug - mostrarTopConAnimacion - Limpiando ranking anterior');
      rankingElement.innerHTML = '';      
      // Mostrar solo top 3 con animaci√≥n
      const top3 = topFinal.slice(0, 3);
      console.log('üîß Debug - mostrarTopConAnimacion - Mostrando top 3:', top3.map(d => d.usernick));
      top3.forEach((donador, index) => {
        setTimeout(() => {
          const donadorElement = crearElementoDonador(donador, index + 1);
          donadorElement.style.opacity = '0';
          donadorElement.style.transform = 'translateY(20px)';
          rankingElement.appendChild(donadorElement);
          console.log(`üîß Debug - mostrarTopConAnimacion - Agregado elemento ${index + 1} para ${donador.usernick}`);
          
          // Animar entrada
          setTimeout(() => {
            donadorElement.style.transition = 'all 0.5s ease';
            donadorElement.style.opacity = '1';
            donadorElement.style.transform = 'translateY(0)';
          }, 100);
        }, index * 300); // Aumentar delay entre cada entrada
      });
      
      // Si hay m√°s de 3 participantes, mostrar mensaje adicional
      if (topFinal.length > 3) {
        setTimeout(() => {
          const mensajeAdicional = document.createElement('div');
          mensajeAdicional.style.cssText = `
            text-align: center;
            color: #ccc;
            font-size: 20px;
            margin-top: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            opacity: 0;
            animation: aparecerMensaje 1s ease-out 0.5s forwards;
          `;
          mensajeAdicional.innerHTML = `
            <span style="color: #ffd700; font-weight: 900;">üìä</span> 
            <span style="font-weight: 900;">${t('totalParticipantes')} ${topFinal.length}</span>
          `;
          rankingElement.appendChild(mensajeAdicional);
        }, 1200);
      }
      
      // Liberar bandera de control
      setTimeout(() => {
        window.topConAnimacionEnProceso = false;
        console.log('üîß Debug - mostrarTopConAnimacion - Bandera liberada');
      }, 1500);
    }
    
    // Funci√≥n para crear elemento de donador
    function crearElementoDonador(donador, posicion) {
      const donadorElement = document.createElement('div');
      donadorElement.className = 'donador finalizado';
      donadorElement.dataset.id = donador.id;
      
      const esTop3 = posicion <= 3;
      const colorPosicion = posicion === 1 ? '#ffd700' : posicion === 2 ? '#c0c0c0' : posicion === 3 ? '#cd7f32' : '#4ecdc4';
      
      donadorElement.innerHTML = `
        <div class="posicion" style="background: ${colorPosicion}; color: white; font-weight: 900; font-size: 20px; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">
          ${posicion}
        </div>
        <div class="foto" style="background-image: url('${donador.userfoto}')"></div>
        <div class="info">
          <div class="nombre" style="font-weight: ${esTop3 ? '900' : 'normal'}; color: ${esTop3 ? colorPosicion : '#fff'};">
            ${donador.usernick}
          </div>
          <div class="diamantes" style="color: ${esTop3 ? colorPosicion : '#ffd700'}; font-weight: ${esTop3 ? '900' : 'normal'};">
            <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#Icon_Color-Tiktok_Coin_svg__a)"><path d="M48 24a24 24 0 1 1-48 0 24 24 0 0 1 48 0Z" fill="#FFB84D"></path><path d="M47 24a23 23 0 1 1-46 0 23 23 0 0 1 46 0Z" fill="#FFDE55"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A300"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A80F"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#E88B00"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#F09207"></path><path d="M34.74 17.77v5.86c-2.06 0-4.05-.44-5.81-1.55v7.2a7.79 7.79 0 0 1-7.84 7.75 7.79 7.79 0 0 1-7.8-8.35 7.79 7.79 0 0 1 9.19-8.24v6c-.47-.13-.9-.26-1.39-.26a3.14 3.14 0 0 0-3.09 2.5 3.14 3.14 0 0 0 3.1 2.5c1.74 0 3.14-1.4 3.14-3.11V12.03h4.69a5.6 5.6 0 0 0 5.81 5.74Z" fill="#F09207"></path><path d="M34.34 18.18a5.78 5.78 0 0 1-5.82-5.74h-3.87v15.63c0 1.94-1.6 3.5-3.56 3.5a3.53 3.53 0 0 1-3.55-3.5 3.53 3.53 0 0 1 4.52-3.38v-3.9a7.38 7.38 0 0 0-8.4 7.28 7.38 7.38 0 0 0 7.43 7.34c4.1 0 7.43-3.29 7.43-7.34v-7.98a9.73 9.73 0 0 0 5.82 1.92v-3.83Z" fill="#fff"></path></g><defs><clipPath id="Icon_Color-Tiktok_Coin_svg__a"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg> 
            ${donador.total_diamantes}
          </div>
        </div>
      `;
      
      return donadorElement;
    }
    
    // Funci√≥n para bloquear la interfaz
    function bloquearInterfaz() {
      // Bloquear botones de control
      const botonesControl = document.querySelectorAll('.btn-control');
      botonesControl.forEach(boton => {
        boton.disabled = true;
        boton.style.opacity = '0.5';
        boton.style.cursor = 'not-allowed';
      });
      
      // Mostrar mensaje de bloqueo
      const mensajeBloqueo = document.createElement('div');
      mensajeBloqueo.id = 'mensajeBloqueo';
      mensajeBloqueo.style.cssText = `
        display:none;
        background: rgba(255, 0, 0, 0.1);
        border: 2px solid rgba(255, 0, 0, 0.5);
        color: #ff6b6b;
        padding: 10px;
        border-radius: 10px;
        text-align: center;
        font-weight: 900;
        font-size: 20px;
        margin: 10px 0;
      `;
      mensajeBloqueo.textContent = t('subastaFinalizadaNoDonaciones');
      
      const headerElement = document.querySelector('.header');
      if (headerElement) {
        headerElement.parentNode.insertBefore(mensajeBloqueo, headerElement.nextSibling);
      }
    }
    
    function finalizarSubasta() {
      subastaFinalizada = true;
      console.log("üîß Debug - tiempoSnipe en finalizarSubasta:", tiempoSnipe);
      
      // Si hay tiempo de snipe configurado, activar el sistema de snipe
      if (tiempoSnipe != 0){
        console.log('üî• Activando sistema de snipe desde finalizarSubasta');
        
        // Configurar el tiempo de snipe
        tiempoSnipeConfigurado = tiempoSnipe * 1000; // Convertir segundos a milisegundos
                
        // Activar el tiempo snipe usando la nueva funci√≥n
        activarTiempoSnipe();
      } else {
        console.log('üèÅ No hay tiempo de snipe, mostrando ganadores directamente');
        subastaFinalizadaSnipe = true; // Marcar como finalizada tambi√©n para evitar duplicaciones
        console.log('üîß Debug - subastaFinalizadaSnipe marcada como true');
        mostrarGanadoresDespuesDelay();
      }
    }

    function mostrarGanadoresDespuesDelay() {
      console.log('üèÜ mostrarGanadoresDespuesDelay() llamado - Sin tiempo de snipe');
      
      // Actualizar estado 
      document.getElementById('status').textContent = 'üèÜ ' + t('subastaFinalizada');
      document.getElementById('status').style.color = '#ffd700';
      document.getElementById('status').style.fontWeight = '900';
      
              // Cambiar el timer a FINALIZADO
        const timerElement = document.getElementById('timer');
        if (timerElement) {
          timerElement.textContent = 'üèÅ ' + t('finalizado');
          timerElement.style.color = '#ffd700';
          timerElement.style.animation = 'none';
          timerElement.style.fontSize = '40px'; // Usar el mismo tama√±o que configuraste
          timerElement.classList.add('finalizado'); // Agregar clase CSS para estilos espec√≠ficos
        }
      
      // Mostrar top final con animaci√≥n completa (igual que cuando hay snipe)
      mostrarTopFinal();
    }
    
    // Funciones para crear efectos visuales
    function crearEfectosCambio(elemento) {
      // Crear destello
      const destello = document.createElement('div');
      destello.className = 'destello';
      elemento.appendChild(destello);
      
      // Crear part√≠culas
      crearParticulas(elemento, 6, '#ffd700');
      
      // Remover destello despu√©s de la animaci√≥n
      setTimeout(() => {
        if (destello.parentNode) {
          destello.parentNode.removeChild(destello);
        }
      }, 800);
    }
    
    function crearEfectosSubida(elemento) {
      // Crear destello verde
      const destello = document.createElement('div');
      destello.className = 'destello';
      destello.style.background = 'linear-gradient(45deg, transparent 30%, rgba(76, 175, 80, 0.6) 50%, transparent 70%)';
      elemento.appendChild(destello);
      
      // Crear part√≠culas verdes
      crearParticulas(elemento, 10, '#4caf50');
      
             // Efecto de flecha hacia arriba (dentro del contenedor)
      const flecha = document.createElement('div');
      flecha.innerHTML = '‚¨ÜÔ∏è';
      flecha.style.cssText = `
        position: absolute;
        top: 3px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        animation: flecha-subida 1.5s ease-out;
        z-index: 1000;
        color: #4caf50;
        text-shadow: 0 0 8px rgba(76, 175, 80, 0.8);
      `;
      elemento.appendChild(flecha);
      
      // Remover elementos despu√©s de la animaci√≥n
      setTimeout(() => {
        if (destello.parentNode) destello.parentNode.removeChild(destello);
        if (flecha.parentNode) flecha.parentNode.removeChild(flecha);
      }, 1500);
    }
    
    function crearEfectosBajada(elemento) {
      // Crear destello rojo
      const destello = document.createElement('div');
      destello.className = 'destello';
      destello.style.background = 'linear-gradient(45deg, transparent 30%, rgba(244, 67, 54, 0.6) 50%, transparent 70%)';
      elemento.appendChild(destello);
      
      // Crear part√≠culas rojas
      crearParticulas(elemento, 10, '#f44336');
      
             // Efecto de flecha hacia abajo (dentro del contenedor)
      const flecha = document.createElement('div');
      flecha.innerHTML = '‚¨áÔ∏è';
      flecha.style.cssText = `
        position: absolute;
        bottom: 3px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 20px;
        animation: flecha-bajada 1.5s ease-out;
        z-index: 1000;
        color: #f44336;
        text-shadow: 0 0 8px rgba(244, 67, 54, 0.8);
      `;
      elemento.appendChild(flecha);
      
      // Remover elementos despu√©s de la animaci√≥n
      setTimeout(() => {
        if (destello.parentNode) destello.parentNode.removeChild(destello);
        if (flecha.parentNode) flecha.parentNode.removeChild(flecha);
      }, 1500);
    }
    
    function crearParticulas(elemento, cantidad, color) {
      const contenedorParticulas = document.createElement('div');
      contenedorParticulas.className = 'particulas';
      
      elemento.appendChild(contenedorParticulas);
      
      for (let i = 0; i < cantidad; i++) {
        const particula = document.createElement('div');
        particula.className = 'particula';
        particula.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          width: 3px;
          height: 3px;
          background: ${color};
          border-radius: 50%;
          box-shadow: 0 0 4px ${color};
        `;
        
        // Direcci√≥n aleatoria para cada part√≠cula (reducida para evitar desbordamiento)
        const angulo = (Math.PI * 2 * i) / cantidad;
        const distancia = 30 + Math.random() * 20;
        const x = Math.cos(angulo) * distancia;
        const y = Math.sin(angulo) * distancia;
        
        particula.style.setProperty('--x', `${x}px`);
        particula.style.setProperty('--y', `${y}px`);
        
        contenedorParticulas.appendChild(particula);
      }
      
      // Remover contenedor de part√≠culas despu√©s de la animaci√≥n
      setTimeout(() => {
        if (contenedorParticulas.parentNode) {
          contenedorParticulas.parentNode.removeChild(contenedorParticulas);
        }
      }, 1000);
    }

    // Agregar estilos CSS para las animaciones adicionales
    const style = document.createElement('style');
    style.textContent = `
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      
      @keyframes ganador-celebracion {
        0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
        50% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
      }
      
      @keyframes ganador-salida {
        from { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        to { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      }
      
      @keyframes notificacion-entrada {
        from { 
          transform: translateX(100%); 
          opacity: 0; 
        }
        to { 
          transform: translateX(0); 
          opacity: 1; 
        }
      }
      
      @keyframes notificacion-salida {
        from { 
          transform: translateX(0); 
          opacity: 1; 
        }
        to { 
          transform: translateX(100%); 
          opacity: 0; 
        }
      }
      
      /* Animaciones para el ganador */
      @keyframes aparecerFondo {
        from { 
          opacity: 0; 
        }
        to { 
          opacity: 1; 
        }
      }
      
      @keyframes desaparecerFondo {
        from { 
          opacity: 1; 
        }
        to { 
          opacity: 0; 
        }
      }
      
      @keyframes aparecerGanador {
        0% { 
          opacity: 0; 
          transform: scale(0.3) rotate(-10deg); 
        }
        50% { 
          opacity: 1; 
          transform: scale(1.1) rotate(5deg); 
        }
        100% { 
          opacity: 1; 
          transform: scale(1) rotate(0deg); 
        }
      }
      
      @keyframes desaparecerGanador {
        0% { 
          opacity: 1; 
          transform: scale(1) rotate(0deg); 
        }
        100% { 
          opacity: 0; 
          transform: scale(0.3) rotate(10deg); 
        }
      }
      
      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { 
          transform: translateY(0); 
        }
        40% { 
          transform: translateY(-10px); 
        }
        60% { 
          transform: translateY(-5px); 
        }
      }
      
      @keyframes aparecerMensaje {
        from { 
          opacity: 0; 
          transform: translateY(10px); 
        }
        to { 
          opacity: 1; 
          transform: translateY(0); 
        }
      }
      
      /* Animaciones para efectos de celebraci√≥n */
      @keyframes confetiCaida {
        0% {
          transform: translateY(-10px) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: translateY(100vh) rotate(720deg);
          opacity: 0;
        }
      }
      
      @keyframes serpentinaCaida {
        0% {
          transform: translateY(-100px) rotate(0deg);
          opacity: 1;
        }
        50% {
          opacity: 0.8;
        }
        100% {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }
      
      @keyframes estrellaBrillo {
        0%, 100% {
          opacity: 0.6;
          transform: scale(1) rotate(0deg);
        }
        50% {
          opacity: 1;
          transform: scale(1.2) rotate(180deg);
        }
      }
    `;
    document.head.appendChild(style);

         // Funci√≥n para mostrar indicador de tiempo positivo
    function mostrarTiempoPositivo(segundos) {
      // console.log(`üîç DEBUG mostrarTiempoPositivo: Tiempo antes: ${tiempoRestante}, Sumando: ${segundos}`);
      
      // Marcar que se est√° modificando el tiempo
      modificandoTiempo = true;
      
      const indicador = document.getElementById('tiempoPositivo');
      indicador.textContent = `+${segundos}`;
      indicador.style.animation = 'none';
      indicador.offsetHeight; // Trigger reflow
      indicador.style.animation = 'tiempo-positivo-animacion 2.5s ease-out forwards';
      
      // Pausar temporalmente el timer para evitar interferencias
      const timerActivo = timerInterval;
      if (timerActivo) {
        clearInterval(timerActivo);
        timerInterval = null; // Importante: limpiar la referencia
      }
      
      // Aplicar el tiempo al timer
      tiempoRestante += segundos;
      // console.log(`üîç DEBUG mostrarTiempoPositivo: Tiempo despu√©s: ${tiempoRestante}`);
      
      actualizarTimer();
      
      // Reanudar el timer despu√©s de un breve delay
      setTimeout(() => {
        if (!pausado && !subastaFinalizada && !timerInterval && !subastaFinalizadaSnipe) {
          // Solo iniciar el timer si no hay uno activo
          iniciarTimer();
        }
        // Marcar que ya no se est√° modificando el tiempo
        modificandoTiempo = false;
      }, 100);
      
      // Limpiar despu√©s de la animaci√≥n
      setTimeout(() => {
        indicador.textContent = '';
      }, 2500);
    }
    
    // Funci√≥n para mostrar indicador de tiempo negativo
    function mostrarTiempoNegativo(segundos) {
      // console.log(`üîç DEBUG mostrarTiempoNegativo: Tiempo antes: ${tiempoRestante}, Restando: ${segundos}`);
      
      // Marcar que se est√° modificando el tiempo
      modificandoTiempo = true;
      
      const indicador = document.getElementById('tiempoNegativo');
      indicador.textContent = `-${segundos}`;
      indicador.style.animation = 'none';
      indicador.offsetHeight; // Trigger reflow
      indicador.style.animation = 'tiempo-negativo-animacion 2.5s ease-out forwards';
      
      // Pausar temporalmente el timer para evitar interferencias
      const timerActivo = timerInterval;
      if (timerActivo) {
        clearInterval(timerActivo);
        timerInterval = null; // Importante: limpiar la referencia
      }
      
      // Aplicar el tiempo al timer
      tiempoRestante = Math.max(0, tiempoRestante - segundos);
      // console.log(`üîç DEBUG mostrarTiempoNegativo: Tiempo despu√©s: ${tiempoRestante}`);
      
      actualizarTimer();
      
      // Reanudar el timer despu√©s de un breve delay
      setTimeout(() => {
        if (!pausado && !subastaFinalizada && !timerInterval) {
          // Solo iniciar el timer si no hay uno activo
          iniciarTimer();
        }
        // Marcar que ya no se est√° modificando el tiempo
        modificandoTiempo = false;
      }, 100);
      
      // Limpiar despu√©s de la animaci√≥n
      setTimeout(() => {
        indicador.textContent = '';
      }, 2500);
    }
    
    // Funci√≥n para iniciar la subasta desde el comando
    function iniciarSubastaDesdeComando(tiempoInicial, _tiempoSnipe, _minimoDonacion) {
      // console.log(`üöÄ Iniciando subasta con tiempo inicial: ${tiempoInicial} segundos`);
      
      // Resetear estado de pausado
      pausado = false;
      tiempoPausado = 0;
      minimoDonacion = _minimoDonacion || 0;
      tiempoRestante = tiempoInicial;
      tiempoSnipe = _tiempoSnipe || 0;
      tiempoRestanteSnipe = tiempoSnipe;
      subastaFinalizada = false;
      subastaFinalizadaSnipe = false;
      subastaIniciada = true;
      donacionesBloqueadas = false;
      topFinalizado = false;
      
      console.log(`üîß Debug - tiempoSnipe configurado: ${tiempoSnipe}s`);
      console.log(`üîß Debug - tiempoRestanteSnipe: ${tiempoRestanteSnipe}s`);
      
      // Actualizar interfaz
      actualizarTimer();
      // Solo actualizar ranking si la subasta no est√° finalizada
      if (!subastaFinalizada || !subastaFinalizadaSnipe) {
        actualizarRanking();
      } else {
        console.log('üîß Debug - iniciarSubastaDesdeComando - Subasta finalizada, saltando actualizarRanking');
      }
      
      const statusElement = document.getElementById('status');
      const timerElement = document.getElementById('timer');
      
      if (statusElement) {
        statusElement.textContent = t('subastaEnCurso');
        statusElement.style.color = '#4ecdc4';
        statusElement.style.fontWeight = 'normal';
      }
      
      if (timerElement) {
        timerElement.style.color = '#4ecdc4';
        timerElement.style.animation = 'none';
      }
      
      // Limpiar cualquier intervalo anterior e iniciar nuevo timer
      clearInterval(timerInterval);
      timerInterval = null;
      
      iniciarTimer();
    }

    // Variables para controlar el estado del timer
    var tiempoPausado = 0; // Variable para guardar el tiempo cuando se pausa
    var pausandoEnProceso = false; // Variable para evitar ejecuciones m√∫ltiples
    var widgetInicializado = false; // Variable para controlar si el widget ya se inicializ√≥
    
         // Funci√≥n para pausar/reanudar la subasta desde el comando
    function pausarSubastaDesdeComando(accionEspecifica = null) {
      // console.log('üéØ pausarSubastaDesdeComando() llamado con par√°metro:', accionEspecifica);
      
      // Verificar si el widget ya est√° inicializado
      if (!widgetInicializado) {
        // console.log('‚ö†Ô∏è Widget no inicializado, ignorando comando de pausa...');
        return;
      }
      
      // Debug para rastrear llamadas
      // debugPausarSubasta();
      
      // Protecci√≥n contra ejecuciones m√∫ltiples
      if (pausandoEnProceso) {
        // console.log('‚ö†Ô∏è Operaci√≥n de pausa/reanudaci√≥n ya en proceso, ignorando...');
        return;
      }
      
      pausandoEnProceso = true;
      
      // Determinar la acci√≥n a realizar
      let debePausar;
      if (accionEspecifica !== null) {
        // Si se especifica una acci√≥n desde el socket, usarla
        debePausar = accionEspecifica;
        // console.log(`üéØ Acci√≥n espec√≠fica recibida: ${debePausar ? 'PAUSAR' : 'REANUDAR'}`);
      } else {
        // Si no hay acci√≥n espec√≠fica, hacer toggle
        debePausar = !pausado;
        // console.log(`üîÑ Acci√≥n por toggle: ${debePausar ? 'PAUSAR' : 'REANUDAR'}`);
      }
      
      if (debePausar && !pausado) {        
        pausado = true;
        tiempoPausado = tiempoRestante; // Guardar el tiempo actual
        clearInterval(timerInterval);
        timerInterval = null;
        
        // Cambiar estado visual a pausado
        const statusElement = document.getElementById('status');
        const timerElement = document.getElementById('timer');
        
        if (statusElement) {
          statusElement.textContent = t('subastaPausada');
          statusElement.style.color = '#ff6b6b';
          statusElement.style.fontWeight = 'bold';
          // console.log('‚úÖ Status actualizado a "pausada"');
        }
        
        if (timerElement) {
          timerElement.style.color = '#ff6b6b';
          timerElement.style.textShadow = '0 0 20px rgba(255, 107, 107, 0.8)';
          timerElement.style.animation = 'none';
          
          // Actualizar borde del contenedor a rojo
          const timerContainer = timerElement.closest('.timer-container');
          if (timerContainer) {
            timerContainer.style.borderColor = '#ff6b6b';
          }
          
          // console.log('‚úÖ Timer actualizado a color rojo (pausado)');
        }
        
        // console.log(`‚è∏Ô∏è Subasta pausada en: ${tiempoPausado} segundos`);
      } else if (!debePausar && pausado) {        
        pausado = false;
        tiempoRestante = tiempoPausado; // Restaurar el tiempo que ten√≠a cuando se paus√≥
                
        // Restaurar estado visual normal
        const statusElement = document.getElementById('status');
        const timerElement = document.getElementById('timer');
        
        if (statusElement) {
          statusElement.textContent = 'Subasta en curso - ¬°Env√≠a regalos!';
          statusElement.style.color = '#4ecdc4';
          statusElement.style.fontWeight = 'normal';
          // console.log('‚úÖ Status actualizado a "en curso"');
        }
        
        if (timerElement) {
          timerElement.style.color = '#4ecdc4';
          timerElement.style.textShadow = '0 0 20px rgba(78, 205, 196, 0.8)';
          timerElement.style.animation = 'none';
          
          // Actualizar borde del contenedor a verde
          const timerContainer = timerElement.closest('.timer-container');
          if (timerContainer) {
            timerContainer.style.borderColor = '#4ecdc4';
          }          
        }
        
        // Actualizar timer y reiniciar el intervalo
        actualizarTimer();
        iniciarTimer(); 
      }
      
      // Liberar la protecci√≥n despu√©s de un breve delay
      setTimeout(() => {
        pausandoEnProceso = false;
      }, 500);
    }

          // Funci√≥n para finalizar la subasta desde el comando
    function finalizarSubastaDesdeComando() {
      console.log('üèÅ finalizarSubastaDesdeComando ejecutado');
      clearInterval(timerInterval);
      
      // Marcar subasta como finalizada
      subastaFinalizada = true;
      
      // Si hay tiempo de snipe configurado, activar el sistema de snipe
      if (tiempoSnipe > 0) {
        console.log('üî• Activando sistema de snipe desde comando');
        // Configurar el tiempo de snipe
        tiempoSnipeConfigurado = tiempoSnipe * 1000;
        // Activar el tiempo snipe usando la nueva funci√≥n
        activarTiempoSnipe();
      } else {
        console.log('üèÅ No hay tiempo de snipe, mostrando ganadores directamente');
        // Usar la nueva funci√≥n en lugar de la antigua
        mostrarTopFinal();
      }
    }

    // Funci√≥n para reiniciar la subasta desde el comando
    // function reiniciarSubastaDesdeComando(tiempoInicial, tiempoSnipe) {
    //   // Limpiar estado de la subasta completamente
    //   subastaFinalizada = false;
    //   subastaFinalizadaSnipe = false;
    //   subastaIniciada = true;
      
    //   // Resetear estado de pausado y snipe
    //   pausado = false;
    //   tiempoPausado = 0;
    //   snipeActivo = false;
    //   topFinalizado = false;
    //   donacionesBloqueadas = false;
      
    //   // Configurar tiempo de snipe si se proporciona
    //   if (tiempoSnipe && tiempoSnipe > 0) {
    //     tiempoSnipeConfigurado = tiempoSnipe * 1000; // Convertir segundos a milisegundos
    //     console.log(`‚è∞ Tiempo de snipe configurado: ${tiempoSnipe} segundos`);
    //   }
      
    //   // Limpiar lista de donadores y reiniciar el ranking
    //   donadores = [];
    //   limpiarRanking();
      
    //   // Establecer tiempo inicial
    //   tiempoRestante = 0;

    //   tiempoSnipe = tiempoSnipe || 0;
    //   // console.log(`üîÑ Reiniciando subasta con tiempo inicial: ${tiempoInicial} segundos`);
      
    //   // Limpiar estado de la subasta completamente
    //   subastaFinalizada = false;
    //   subastaFinalizadaSnipe = false;
    //   subastaIniciada = true;
      
    //   // Resetear estado de pausado
    //   pausado = false;
    //   tiempoPausado = 0;
      
    //   // Limpiar lista de donadores y reiniciar el ranking
    //   donadores = [];
    //   limpiarRanking();
      
    //   // Establecer tiempo inicial
    //   tiempoRestante = 0;

    //   tiempoSnipe = tiempoSnipe || 0;
      
    //   // console.log(`‚è±Ô∏è Tiempo restante establecido: ${tiempoRestante}`);
      
    //   // Actualizar interfaz
    //   actualizarTimer();
    //   // Solo actualizar ranking si la subasta no est√° finalizada
    //   if (!subastaFinalizada || !subastaFinalizadaSnipe) {
    //     actualizarRanking();
    //   } else {
    //     console.log('üîß Debug - reiniciarSubastaDesdeComando - Subasta finalizada, saltando actualizarRanking');
    //   }
      
    //   // Restaurar estado normal del timer y status
    //   const statusElement = document.getElementById('status');
    //   const timerElement = document.getElementById('timer');
      
    //           if (statusElement) {
    //       statusElement.textContent = t('subastaEnCurso');
    //       statusElement.style.color = '#4ecdc4';
    //       statusElement.style.fontWeight = 'normal';
    //     }
      
    //   if (timerElement) {
    //     timerElement.style.color = '#4ecdc4';
    //     timerElement.style.textShadow = '0 0 20px rgba(78, 205, 196, 0.8)';
    //     timerElement.style.animation = 'none';
    //     timerElement.style.fontSize = '52px'; // Restaurar tama√±o normal del timer
    //     timerElement.classList.remove('finalizado'); // Remover clase de finalizado
        
    //     // Actualizar borde del contenedor a verde
    //     const timerContainer = timerElement.closest('.timer-container');
    //     if (timerContainer) {
    //       timerContainer.style.borderColor = '#4ecdc4';
    //     }
    //   }
      
    //   // Limpiar cualquier intervalo anterior e iniciar nuevo timer
    //   clearInterval(timerInterval);
    //   timerInterval = null;      
    // }
    
    // Funci√≥n para actualizar el idioma del widget din√°micamente
    function actualizarIdiomaWidget() {
      console.log('üåç Actualizando idioma del widget a:', obtenerIdioma());
      
      // Actualizar delay timer label
      const delayTimerLabel = document.getElementById('delayTimerLabel');
      if (delayTimerLabel) {
        delayTimerLabel.textContent = t('tiempoPorDelay');
      }
      
      // Actualizar status si existe
      const statusElement = document.getElementById('status');
      if (statusElement && !subastaFinalizada) {
        if (subastaIniciada && !pausado) {
          statusElement.textContent = t('subastaEnCurso');
        } else if (pausado) {
          statusElement.textContent = t('subastaPausada');
        } else {
          statusElement.textContent = t('esperandoDonaciones');
        }
      }
      
      // Actualizar t√≠tulo del ranking
      const rankingTitle = document.getElementById('rankingTitle');
      if (rankingTitle) {
        if (subastaFinalizada && subastaFinalizadaSnipe) {
          rankingTitle.innerHTML = 'üèÜ ' + t('topFinalSubasta');
        } else {
          rankingTitle.textContent = t('top10Donadores');
        }
      }
      
      console.log('‚úÖ Idioma del widget actualizado');
      
      // Tambi√©n actualizar idioma de las animaciones si est√°n activas
      actualizarIdiomaAnimaciones();
    }
    
    // Funci√≥n para actualizar el idioma de las animaciones activas
    function actualizarIdiomaAnimaciones() {
      console.log('üåç Actualizando idioma de las animaciones activas');
      
      // Actualizar animaci√≥n del ganador si est√° activa
      const animacionGanador = document.getElementById('animacionGanador');
      if (animacionGanador) {
        const contenidoAnimacion = animacionGanador.querySelector('div');
        if (contenidoAnimacion) {
          contenidoAnimacion.innerHTML = `
            <div style="font-size: 48px; font-weight: 900; margin-bottom: 20px; animation: bounce 1s infinite;">üèÜ</div>
            <div style="font-size: 32px; font-weight: 900; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
              ${t('ganador')}
            </div>
            <div style="font-size: 24px; font-weight: 900; margin-bottom: 20px; color: #8B0000;">
              ${window.ganadorActual?.usernick || 'Usuario'}
            </div>
            <div style="font-size: 20px; font-weight: 900; margin-bottom: 15px; background: rgba(255,255,255,0.3); padding: 10px; border-radius: 10px;">
              <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#Icon_Color-Tiktok_Coin_svg__a)"><path d="M48 24a24 24 0 1 1-48 0 24 24 0 0 1 48 0Z" fill="#FFB84D"></path><path d="M47 24a23 23 0 1 1-46 0 23 23 0 0 1 46 0Z" fill="#FFDE55"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A300"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A80F"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#E88B00"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#F09207"></path><path d="M34.74 17.77v5.86c-2.06 0-4.05-.44-5.81-1.55v7.2a7.79 7.79 0 0 1-7.84 7.75 7.79 7.79 0 0 1-7.8-8.35 7.79 7.79 0 0 1 9.19-8.24v6c-.47-.13-.9-.26-1.39-.26a3.14 3.14 0 0 0-3.09 2.5 3.14 3.14 0 0 0 3.1 2.5c1.74 0 3.14-1.4 3.14-3.11V12.03h4.69a5.6 5.6 0 0 0 5.81 5.74Z" fill="#F09207"></path><path d="M34.34 18.18a5.78 5.78 0 0 1-5.82-5.74h-3.87v15.63c0 1.94-1.6 3.5-3.56 3.5a3.53 3.53 0 0 1-3.55-3.5 3.53 3.53 0 0 1 4.52-3.38v-3.9a7.38 7.38 0 0 0-8.4 7.28 7.38 7.38 0 0 0 7.43 7.34c4.1 0 7.43-3.29 7.43-7.34v-7.98a9.73 9.73 0 0 0 5.82 1.92v-3.83Z" fill="#fff"></path></g><defs><clipPath id="Icon_Color-Tiktok_Coin_svg__a"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg> ${window.ganadorActual?.total_diamantes || 0} ${t('diamantes')}
            </div>
            <div style="font-size: 20px; font-weight: 900; opacity: 0.8; margin-top: 20px;">
              üéâ ${t('felicidades')} üéâ
            </div>
          `;
        }
      }
      
      // Actualizar animaci√≥n de empate si est√° activa
      const animacionEmpate = document.getElementById('animacionEmpate');
      if (animacionEmpate) {
        const contenidoAnimacion = animacionEmpate.querySelector('div');
        if (contenidoAnimacion && window.empatadosActuales) {
          contenidoAnimacion.innerHTML = `
            <div style="font-size: 48px; font-weight: 900; margin-bottom: 20px; animation: bounce 1s infinite;">ü§ù</div>
            <div style="font-size: 32px; font-weight: 900; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
              ${t('empate')}
            </div>
            <div style="font-size: 24px; font-weight: 900; margin-bottom: 20px; color: #ffd700;">
              ${window.empatadosActuales.map(e => e.usernick).join(' y ')}
            </div>
            <div style="font-size: 20px; font-weight: 900; margin-bottom: 15px; background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
              <svg style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 4px;" viewBox="0 0 48 48" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#Icon_Color-Tiktok_Coin_svg__a)"><path d="M48 24a24 24 0 1 1-48 0 24 24 0 0 1 48 0Z" fill="#FFB84D"></path><path d="M47 24a23 23 0 1 1-46 0 23 23 0 0 1 46 0Z" fill="#FFDE55"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A300"></path><path d="M42 24a18 18 0 1 1-36 0 18 18 0 0 1 36 0Z" fill="#F7A80F"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#E88B00"></path><path d="M41.94 25.5a18 18 0 1 0-35.88 0 18 18 0 0 1 35.88 0Z" fill="#F09207"></path><path d="M34.74 17.77v5.86c-2.06 0-4.05-.44-5.81-1.55v7.2a7.79 7.79 0 0 1-7.84 7.75 7.79 7.79 0 0 1-7.8-8.35 7.79 7.79 0 0 1 9.19-8.24v6c-.47-.13-.9-.26-1.39-.26a3.14 3.14 0 0 0-3.09 2.5 3.14 3.14 0 0 0 3.1 2.5c1.74 0 3.14-1.4 3.14-3.11V12.03h4.69a5.6 5.6 0 0 0 5.81 5.74Z" fill="#F09207"></path><path d="M34.34 18.18a5.78 5.78 0 0 1-5.82-5.74h-3.87v15.63c0 1.94-1.6 3.5-3.56 3.5a3.53 3.53 0 0 1-3.55-3.5 3.53 3.53 0 0 1 4.52-3.38v-3.9a7.38 7.38 0 0 0-8.4 7.28 7.38 7.38 0 0 0 7.43 7.34c4.1 0 7.43-3.29 7.43-7.34v-7.98a9.73 9.73 0 0 0 5.82 1.92v-3.83Z" fill="#fff"></path></g><defs><clipPath id="Icon_Color-Tiktok_Coin_svg__a"><path fill="#fff" d="M0 0h48v48H0z"></path></clipPath></defs></svg> ${window.empatadosActuales[0]?.total_diamantes || 0} ${t('diamantes')} cada uno
            </div>
            <div style="font-size: 20px; font-weight: 900; opacity: 0.8; margin-top: 20px;">
              üéâ ${t('seVieneDesempate')} üéâ
            </div>
          `;
        }
      }
      
      console.log('‚úÖ Idioma de las animaciones actualizado');
    }

    // Funci√≥n para modificar el tiempo desde el comando
    function modificarTiempoDesdeComando(segundos, tipo) {
      // Las funciones mostrarTiempoPositivo y mostrarTiempoNegativo ya modifican
      // el tiempo y actualizan la interfaz, por lo que solo las llamamos
      if (tipo === 'sumar') {
        mostrarTiempoPositivo(segundos);
      } else if (tipo === 'restar') {
        mostrarTiempoNegativo(segundos);
      }
    }

    var grupoRegalos = {}
    // Funci√≥n para procesar donaciones recibidas por socket
    // Funci√≥n para procesar una donaci√≥n recibida y actualizar el ranking de donadores
    procesarDonacion = (datosDonacion) => {
      console.log('üéÅ Procesando donaci√≥n:', datosDonacion);
      // Extraer informaci√≥n relevante del objeto
      const {
        uniqueId = null,           // ID √∫nico del usuario
        nickname = null,           // Nombre del usuario
        profilePictureUrl = null,  // URL de la foto de perfil
        diamondCount = null,       // Cantidad de diamantes de esta donaci√≥n
        giftName = null,           // Nombre del regalo
        repeatCount = null,        // Cantidad de veces que se repite el regalo
        timestamp = null           // Timestamp de la donaci√≥n
      } = datosDonacion;

      var montoExtra = 1;
      var groupId = parseInt(datosDonacion?.giftType) === 1 ? datosDonacion?.groupId : datosDonacion?.msgId;
      console.log('üîé groupId calculado:', groupId);

      if (groupId != "0") {
        if (grupoRegalos[groupId]) {
          montoExtra = datosDonacion.repeatCount - grupoRegalos[groupId];
          grupoRegalos[groupId] = datosDonacion.repeatCount;
          console.log(`üîÑ Actualizando grupoRegalos[${groupId}] a ${datosDonacion.repeatCount}, montoExtra: ${montoExtra}`);
        } else {
          grupoRegalos[groupId] = datosDonacion.repeatCount;
          montoExtra = datosDonacion.repeatCount;
          console.log(`üÜï Nuevo grupoRegalos[${groupId}] = ${datosDonacion.repeatCount}, montoExtra: ${montoExtra}`);
        }
      }

      // Calcular diamantes totales (diamondCount * repeatCount)
      const diamantesTotales = montoExtra * parseInt(datosDonacion?.diamondCount);
      console.log(`üíé Diamantes totales calculados: ${diamantesTotales} (montoExtra: ${montoExtra}, diamondCount: ${datosDonacion?.diamondCount})`);

      if (diamantesTotales <= 0) {
        console.log('‚ö†Ô∏è Donaci√≥n sin diamantes v√°lidos, ignorando...');
        return;
      }

      // Buscar si el donador ya existe en la lista
      const donadorExistente = donadores.find(d => d.id === uniqueId);

      if (donadorExistente) {
        // Actualizar donador existente
        const diamantesAnteriores = donadorExistente.total_diamantes;
        donadorExistente.total_diamantes += diamantesTotales;
        donadorExistente.ultima_donacion = timestamp;
        donadorExistente.regalos_recibidos = (donadorExistente.regalos_recibidos || 0) + 1;

        console.log(`üí∞ Donador existente: ${donadorExistente.usernick} suma ${diamantesTotales} diamantes (antes: ${diamantesAnteriores}, ahora: ${donadorExistente.total_diamantes})`);

        // Guardar posici√≥n anterior para efectos visuales
        const posicionAnterior = donadores.findIndex(d => d.id === uniqueId);

        // Reordenar la lista por total de diamantes
        donadores.sort((a, b) => b.total_diamantes - a.total_diamantes);

        // Obtener nueva posici√≥n
        const nuevaPosicion = donadores.findIndex(d => d.id === uniqueId);

        console.log(`üîÑ Posici√≥n de ${donadorExistente.usernick}: de ${posicionAnterior} a ${nuevaPosicion}`);

        // Aplicar efectos visuales si cambi√≥ de posici√≥n
        setTimeout(() => {
          aplicarEfectosCambioPosicion(donadorExistente, posicionAnterior, nuevaPosicion);
        }, 100);

      } else {
        // Crear nuevo donador
        const nuevoDonador = {
          id: uniqueId,
          usernick: nickname || 'Usuario',
          userfoto: profilePictureUrl || 'https://via.placeholder.com/35x35/ffd700/000?text=?',
          total_diamantes: diamantesTotales,
          ultima_donacion: timestamp,
          regalos_recibidos: 1,
          primer_regalo: giftName
        };

        donadores.push(nuevoDonador);
        console.log(`üéÅ Nuevo donador agregado: ${nuevoDonador.usernick} con ${nuevoDonador.total_diamantes} diamantes`);

        // Reordenar la lista
        donadores.sort((a, b) => b.total_diamantes - a.total_diamantes);
      }

      try{
        socket.emit("conexion_widgets", {
          widget: SOCKET_IDENTIFICADOR,
          comando: "nuevo_donador",
          valores: donadores
        });
      }catch(e){
        console.log("‚ùå Error enviando nuevo_donador al socket:", e);
      }

      // Limitar a top 10 donadores
      if (donadores.length > 10) {
        console.log('üîü Limite de top 10 alcanzado, recortando lista');
        donadores = donadores.slice(0, 10);
      }

      // Actualizar el ranking en la interfaz
      actualizarRanking();
      console.log('üèÜ Ranking actualizado');

      // Si est√° en tiempo snipe, actualizar top en tiempo real
      if (snipeActivo && !topFinalizado) {
        console.log('‚è±Ô∏è Snipe activo, actualizando top en tiempo real');
        actualizarTopEnTiempoReal();
      }
      console.log('‚úÖ Donaci√≥n procesada correctamente');
      return true; // Indicar que la donaci√≥n fue procesada exitosamente
    }
    
    // Funci√≥n para actualizar top en tiempo real durante snipe
    function actualizarTopEnTiempoReal() {
      console.log('üîÑ Actualizando top en tiempo real durante snipe...');
      
      // Ordenar participantes por donaci√≥n m√°s alta
      const topActual = [...donadores].sort((a, b) => b.total_diamantes - a.total_diamantes);
      
      // Actualizar display del top
      actualizarRanking();
      
      // Agregar indicador visual de que se est√° actualizando
      const rankingElement = document.getElementById('ranking');
      if (rankingElement) {
        rankingElement.style.border = '3px solid #ff6b6b';
        rankingElement.style.boxShadow = '0 0 20px rgba(255, 107, 107, 0.6)';
        
        // Remover el indicador despu√©s de un tiempo
        setTimeout(() => {
          rankingElement.style.border = '2px solid rgba(255, 255, 255, 0.1)';
          rankingElement.style.boxShadow = 'none';
        }, 2000);
      }
      
      console.log('‚úÖ Top actualizado en tiempo real');
    }
    
    // Funci√≥n para aplicar efectos visuales cuando cambia la posici√≥n
    function aplicarEfectosCambioPosicion(donador, posicionAnterior, nuevaPosicion) {
      const donadorElement = document.querySelector(`[data-id="${donador.id}"]`);
      
      if (!donadorElement) return;
      
      if (nuevaPosicion < posicionAnterior) {
        // Subi√≥ de posici√≥n
        // console.log(`üéØ ${donador.usernick} SUBI√ì de posici√≥n ${posicionAnterior + 1} a ${nuevaPosicion + 1}`);
        donadorElement.classList.add('cambio-subida');
        crearEfectosSubida(donadorElement);
        setTimeout(() => {
          donadorElement.classList.remove('cambio-subida');
        }, 1500);
      } else if (nuevaPosicion > posicionAnterior) {
        // Baj√≥ de posici√≥n
        // console.log(`üìâ ${donador.usernick} BAJ√ì de posici√≥n ${posicionAnterior + 1} a ${nuevaPosicion + 1}`);
        donadorElement.classList.add('cambio-bajada');
        crearEfectosBajada(donadorElement);
        setTimeout(() => {
          donadorElement.classList.remove('cambio-bajada');
        }, 1500);
      } else {
        // Misma posici√≥n
        // console.log(`‚û°Ô∏è ${donador.usernick} mantiene posici√≥n ${posicionAnterior + 1}`);
        donadorElement.classList.add('cambio');
        crearEfectosCambio(donadorElement);
        setTimeout(() => {
          donadorElement.classList.remove('cambio');
        }, 1200);
      }
    }
    
    // Funci√≥n para limpiar el ranking y mostrar mensaje de inicio
    function limpiarRanking() {
      const rankingElement = document.getElementById('ranking');
      const rankingTitle = document.getElementById('rankingTitle');
      
      // Limpiar completamente el estado visual
      rankingElement.className = 'ranking';
      rankingTitle.textContent = 'TOP 10 DONADORES';
      
      // Mostrar mensaje de inicio limpio
      rankingElement.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">üéØ ¬°La subasta ha comenzado!<br>Env√≠a regalos para aparecer en el ranking</div>';
      
      // Asegurar que no haya elementos con clases de finalizaci√≥n
      rankingElement.classList.remove('finalizado');
      
      // console.log('üßπ Ranking limpiado completamente para nueva subasta');
    }

    // Funci√≥n para activar el tiempo snipe
    function activarTiempoSnipe() {
      console.log('üî• ¬°TIEMPO SNIPE ACTIVADO!');
      snipeActivo = true;
      // Asegurar que el tiempo de snipe sea correcto
      if (tiempoSnipeConfigurado > 0) {
        tiempoRestanteSnipe = Math.floor(tiempoSnipeConfigurado / 1000); // Convertir ms a segundos
      } else {
        // Si no hay tiempo configurado, usar el valor de tiempoSnipe
        if (tiempoSnipe > 0) {
          tiempoRestanteSnipe = tiempoSnipe;
          tiempoSnipeConfigurado = tiempoSnipe * 1000; // Configurar tambi√©n aqu√≠
        } else {
          tiempoRestanteSnipe = 5; // Valor por defecto
          tiempoSnipeConfigurado = 5000;
        }
      }
      console.log(`üîß Debug - tiempoSnipe: ${tiempoSnipe}s`);
      console.log(`üîß Debug - tiempoSnipeConfigurado: ${tiempoSnipeConfigurado}ms`);
      console.log(`üîß Debug - tiempoRestanteSnipe inicializado: ${tiempoRestanteSnipe}s`);
      // Verificar que el tiempo sea v√°lido antes de continuar
      if (tiempoRestanteSnipe <= 0) {
        console.error('‚ùå Tiempo de snipe inv√°lido, usando valor por defecto');
        tiempoRestanteSnipe = 5;
        tiempoSnipeConfigurado = 5000;
      }
      // MOSTRAR EL DELAY TIMER CON EL TIEMPO DE SNIPE
      const delayTimerContainer = document.getElementById('delaytimercontainer');
      const delayTimer = document.getElementById('delaytimer');
      if (delayTimerContainer && delayTimer) {
        delayTimerContainer.style.display = 'flex';
        delayTimer.textContent = `${tiempoRestanteSnipe}s`;
        delayTimer.style.color = '#ff6b6b';
        delayTimer.style.fontWeight = '900';
        delayTimer.style.animation = 'parpadeoSnipe 1s infinite';
      }
      // Cambiar visual del timer principal - MANTENERLO EN 0:00
      const timerElement = document.getElementById('timer');
      if (timerElement) {
        timerElement.textContent = '0:00';
        timerElement.style.color = '#ff0000';
        timerElement.style.fontWeight = 'bold';
        timerElement.style.textShadow = '0 0 20px rgba(255, 0, 0, 0.8)';
        timerElement.style.animation = 'parpadeoSnipe 1s infinite';
      }
      // Mostrar mensaje de snipe
      mostrarMensajeSnipe();
      // Cambiar estado de la subasta
      const statusElement = document.getElementById('status');
      if (statusElement) {
        statusElement.innerHTML = `
          üî• ¬°TIEMPO SNIPE ACTIVO! ¬°√öltimas donaciones!<br>
                  <span style="font-size: 20px; opacity: 0.9; display: block; margin-top: 3px;">
          ‚ö†Ô∏è <strong>NO DONES</strong> si ves el timer principal en 0:00
        </span>
        `;
        statusElement.style.color = '#ff6b6b';
        statusElement.style.fontWeight = '900';
        statusElement.style.background = 'rgba(255, 107, 107, 0.1)';
        statusElement.style.borderColor = 'rgba(255, 107, 107, 0.5)';
      }
      // Iniciar timer del snipe
      iniciarTimerSnipe();
      console.log(`‚è∞ Tiempo snipe iniciado: ${tiempoRestanteSnipe} segundos`);
    }
    
    // Funci√≥n para mostrar mensaje de snipe
    function mostrarMensajeSnipe() {
      // Remover mensaje anterior si existe
      const mensajeAnterior = document.getElementById('mensajeSnipe');
      if (mensajeAnterior) {
        mensajeAnterior.remove();
      }
    }
  </script>
</body>
</html>